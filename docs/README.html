<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.26">
<title>USB Microscope Camera Web Interface</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock pre>code{display:block}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge, pre.rouge .w {
  color: #24292f;
  background-color: #f6f8fa;
}
pre.rouge .k, pre.rouge .kd, pre.rouge .kn, pre.rouge .kp, pre.rouge .kr, pre.rouge .kt, pre.rouge .kv {
  color: #cf222e;
}
pre.rouge .gr {
  color: #f6f8fa;
}
pre.rouge .gd {
  color: #82071e;
  background-color: #ffebe9;
}
pre.rouge .nb {
  color: #953800;
}
pre.rouge .nc {
  color: #953800;
}
pre.rouge .no {
  color: #953800;
}
pre.rouge .nn {
  color: #953800;
}
pre.rouge .sr {
  color: #116329;
}
pre.rouge .na {
  color: #116329;
}
pre.rouge .nt {
  color: #116329;
}
pre.rouge .gi {
  color: #116329;
  background-color: #dafbe1;
}
pre.rouge .ges {
  font-weight: bold;
  font-style: italic;
}
pre.rouge .kc {
  color: #0550ae;
}
pre.rouge .l, pre.rouge .ld, pre.rouge .m, pre.rouge .mb, pre.rouge .mf, pre.rouge .mh, pre.rouge .mi, pre.rouge .il, pre.rouge .mo, pre.rouge .mx {
  color: #0550ae;
}
pre.rouge .sb {
  color: #0550ae;
}
pre.rouge .bp {
  color: #0550ae;
}
pre.rouge .ne {
  color: #0550ae;
}
pre.rouge .nl {
  color: #0550ae;
}
pre.rouge .py {
  color: #0550ae;
}
pre.rouge .nv, pre.rouge .vc, pre.rouge .vg, pre.rouge .vi, pre.rouge .vm {
  color: #0550ae;
}
pre.rouge .o, pre.rouge .ow {
  color: #0550ae;
}
pre.rouge .gh {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .gu {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .sc, pre.rouge .dl, pre.rouge .sd, pre.rouge .s2, pre.rouge .se, pre.rouge .sh, pre.rouge .sx, pre.rouge .s1, pre.rouge .ss {
  color: #0a3069;
}
pre.rouge .nd {
  color: #8250df;
}
pre.rouge .nf, pre.rouge .fm {
  color: #8250df;
}
pre.rouge .err {
  color: #f6f8fa;
  background-color: #82071e;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cm, pre.rouge .cp, pre.rouge .cpf, pre.rouge .c1, pre.rouge .cs {
  color: #6e7781;
}
pre.rouge .gl {
  color: #6e7781;
}
pre.rouge .gt {
  color: #6e7781;
}
pre.rouge .ni {
  color: #24292f;
}
pre.rouge .si {
  color: #24292f;
}
pre.rouge .ge {
  color: #24292f;
  font-style: italic;
}
pre.rouge .gs {
  color: #24292f;
  font-weight: bold;
}
</style>
</head>
<body class="article toc2 toc-right">
<div id="header">
<h1>USB Microscope Camera Web Interface</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_description">1. Description</a></li>
<li><a href="#_quick_start">2. Quick Start</a></li>
<li><a href="#_hardware_used">3. Hardware used</a></li>
<li><a href="#_led_status_display_unicorn_hat">4. LED Status Display (Unicorn HAT)</a>
<ul class="sectlevel2">
<li><a href="#_row_layout_bottom_to_top">4.1. Row Layout (bottom to top)</a></li>
<li><a href="#_startup_sequence">4.2. Startup Sequence</a></li>
<li><a href="#_error_pattern">4.3. Error Pattern</a></li>
</ul>
</li>
<li><a href="#_system_setup">5. System Setup</a>
<ul class="sectlevel2">
<li><a href="#_pi_zero_status_check">5.1. Pi Zero Status Check</a>
<ul class="sectlevel3">
<li><a href="#_hardware_tests_before_going_full_in">5.1.1. Hardware Tests (before going full in)</a>
<ul class="sectlevel4">
<li><a href="#_why_this">5.1.1.1. Why This</a></li>
<li><a href="#_why_this_way">5.1.1.2. Why This Way</a></li>
<li><a href="#_quick_start_2">5.1.1.3. Quick Start</a></li>
<li><a href="#_hardware_check">5.1.1.4. Hardware Check</a></li>
<li><a href="#_tests">5.1.1.5. Tests</a>
<ul class="sectlevel5">
<li><a href="#_led_hat">5.1.1.5.1. LED HAT</a></li>
<li><a href="#_battery">5.1.1.5.2. Battery</a></li>
<li><a href="#_camera">5.1.1.5.3. Camera</a></li>
</ul>
</li>
<li><a href="#_troubleshooting">5.1.1.6. Troubleshooting</a></li>
<li><a href="#_notes">5.1.1.7. Notes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#_access_web_interface">6. Access Web Interface</a></li>
<li><a href="#_configuration">7. Configuration</a></li>
<li><a href="#_troubleshooting_2">8. Troubleshooting</a>
<ul class="sectlevel2">
<li><a href="#_armv6_vs_armv7_architecture_error">8.1. ARMv6 vs ARMv7 Architecture Error</a></li>
<li><a href="#_build_fails_with_code_139">8.2. Build Fails with Code 139</a></li>
<li><a href="#_device_not_found">8.3. Device Not Found</a></li>
<li><a href="#_unsupported_format">8.4. Unsupported Format</a></li>
<li><a href="#_container_fails_to_start">8.5. Container Fails to Start</a></li>
<li><a href="#_container_permissions">8.6. Container Permissions</a></li>
<li><a href="#_low_performance_on_pi_zero_if_you_hit_that">8.7. Low Performance on Pi Zero (if you hit that)</a></li>
<li><a href="#_leds_not_working">8.8. LEDs Not Working</a></li>
<li><a href="#_multiple_video_devices">8.9. Multiple Video Devices</a></li>
</ul>
</li>
<li><a href="#_pi_zero_microscope_setup">9. Pi Zero Microscope Setup</a>
<ul class="sectlevel2">
<li><a href="#_buildrebuild">9.1. Build/Rebuild</a></li>
<li><a href="#_initial_setup">9.2. Initial Setup</a></li>
<li><a href="#_enable_hardware_interfaces">9.3. Enable Hardware Interfaces</a></li>
<li><a href="#_install_docker">9.4. Install Docker</a></li>
<li><a href="#_install_docker_compose">9.5. Install Docker Compose</a></li>
<li><a href="#_environment_configuration">9.6. Environment Configuration</a>
<ul class="sectlevel3">
<li><a href="#_setup">9.6.1. Setup</a></li>
<li><a href="#_required_changes">9.6.2. Required Changes</a></li>
<li><a href="#_configuration_variables">9.6.3. Configuration Variables</a>
<ul class="sectlevel4">
<li><a href="#_camera_2">9.6.3.1. Camera</a></li>
<li><a href="#_web_server">9.6.3.2. Web Server</a></li>
<li><a href="#_authentication">9.6.3.3. Authentication</a></li>
<li><a href="#_hardware">9.6.3.4. Hardware</a></li>
<li><a href="#_battery_2">9.6.3.5. Battery</a></li>
</ul>
</li>
<li><a href="#_deployment">9.6.4. Deployment</a></li>
<li><a href="#_security">9.6.5. Security</a></li>
</ul>
</li>
<li><a href="#_deploy_application">9.7. Deploy Application</a></li>
<li><a href="#_security_configuration">9.8. Security Configuration</a>
<ul class="sectlevel3">
<li><a href="#_authentication_2">9.8.1. Authentication</a>
<ul class="sectlevel4">
<li><a href="#_credentials">9.8.1.1. Credentials</a></li>
</ul>
</li>
<li><a href="#_httpstls">9.8.2. HTTPS/TLS</a>
<ul class="sectlevel4">
<li><a href="#_certificate_details">9.8.2.1. Certificate Details</a></li>
<li><a href="#_disable_https">9.8.2.2. Disable HTTPS</a></li>
</ul>
</li>
<li><a href="#_path_traversal_protection">9.8.3. Path Traversal Protection</a></li>
<li><a href="#_privileged_mode_removed">9.8.4. Privileged Mode Removed</a></li>
<li><a href="#_health_check">9.8.5. Health Check</a></li>
<li><a href="#_protected_endpoints">9.8.6. Protected Endpoints</a></li>
<li><a href="#_recommendations">9.8.7. Recommendations</a></li>
<li><a href="#_file_security">9.8.8. File Security</a></li>
<li><a href="#_known_limitations">9.8.9. Known Limitations</a></li>
</ul>
</li>
<li><a href="#_verify_hardware">9.9. Verify Hardware</a></li>
<li><a href="#_host_state">9.10. Host State</a></li>
<li><a href="#_planned_features_not_yet_implemented">9.11. Planned Features Not Yet Implemented</a>
<ul class="sectlevel3">
<li><a href="#_current_implementation_status">9.11.1. Current Implementation Status</a></li>
<li><a href="#_implementation_priority">9.11.2. Implementation Priority</a></li>
</ul>
</li>
<li><a href="#_security_fixes_and_improvements_applied">9.12. Security Fixes and Improvements Applied</a>
<ul class="sectlevel3">
<li><a href="#_critical_fixes">9.12.1. Critical Fixes</a>
<ul class="sectlevel4">
<li><a href="#_path_traversal_vulnerability">9.12.1.1. Path Traversal Vulnerability</a></li>
<li><a href="#_authentication_added">9.12.1.2. Authentication Added</a></li>
<li><a href="#_https_support">9.12.1.3. HTTPS Support</a></li>
<li><a href="#_privileged_mode_removed_2">9.12.1.4. Privileged Mode Removed</a></li>
</ul>
</li>
<li><a href="#_configuration_changes">9.12.2. Configuration Changes</a>
<ul class="sectlevel4">
<li><a href="#_environment_variables_centralized">9.12.2.1. Environment Variables Centralized</a></li>
<li><a href="#_health_check_added">9.12.2.2. Health Check Added</a></li>
<li><a href="#_ports_updated">9.12.2.3. Ports Updated</a></li>
</ul>
</li>
<li><a href="#_documentation_created">9.12.3. Documentation Created</a>
<ul class="sectlevel4">
<li><a href="#_new_files">9.12.3.1. New Files</a></li>
<li><a href="#_updated_files">9.12.3.2. Updated Files</a></li>
</ul>
</li>
<li><a href="#_files_modified">9.12.4. Files Modified</a>
<ul class="sectlevel4">
<li><a href="#_core_application">9.12.4.1. Core Application</a></li>
</ul>
</li>
<li><a href="#_deployment_changes">9.12.5. Deployment Changes</a></li>
<li><a href="#_security_recommendations">9.12.6. Security Recommendations</a></li>
<li><a href="#_testing">9.12.7. Testing</a></li>
<li><a href="#_next_steps">9.12.8. Next Steps</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_references">Appendix A: References</a></li>
<li><a href="#_images">Appendix B: images</a>
<ul class="sectlevel2">
<li><a href="#_images_2">B.1. Images</a>
<ul class="sectlevel3">
<li><a href="#_here_the_overall_idea">B.1.1. here the overall idea</a></li>
<li><a href="#_captures_from_the_scope">B.1.2. Captures from the scope</a></li>
<li><a href="#_the_project_itself">B.1.3. the project itself</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_architecture_decision_records">Appendix C: Architecture Decision Records</a>
<ul class="sectlevel2">
<li><a href="#_what_is_an_adr">C.1. What is an ADR</a></li>
<li><a href="#_format">C.2. Format</a></li>
<li><a href="#_records">C.3. Records</a>
<ul class="sectlevel3">
<li><a href="#_adr_001_container_first_architecture">C.3.1. ADR-001: Container-First Architecture</a>
<ul class="sectlevel4">
<li><a href="#_context">C.3.1.1. Context</a></li>
<li><a href="#_decision">C.3.1.2. Decision</a></li>
<li><a href="#_consequences">C.3.1.3. Consequences</a>
<ul class="sectlevel5">
<li><a href="#_positive">C.3.1.3.1. Positive</a></li>
<li><a href="#_negative">C.3.1.3.2. Negative</a></li>
<li><a href="#_implementation">C.3.1.3.3. Implementation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_adr_008_asciidoc_conditional_settings_for_multi_format_publishing">C.3.2. ADR-008: AsciiDoc Conditional Settings for Multi-Format Publishing</a>
<ul class="sectlevel4">
<li><a href="#_context_2">C.3.2.1. Context</a></li>
<li><a href="#_decision_2">C.3.2.2. Decision</a></li>
<li><a href="#_consequences_2">C.3.2.3. Consequences</a>
<ul class="sectlevel5">
<li><a href="#_positive_2">C.3.2.3.1. Positive</a></li>
<li><a href="#_negative_2">C.3.2.3.2. Negative</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_adr_002_security_model_and_authentication">C.3.3. ADR-002: Security Model and Authentication</a>
<ul class="sectlevel4">
<li><a href="#_context_3">C.3.3.1. Context</a></li>
<li><a href="#_decision_3">C.3.3.2. Decision</a>
<ul class="sectlevel5">
<li><a href="#_authentication_3">C.3.3.2.1. Authentication</a></li>
<li><a href="#_httpstls_2">C.3.3.2.2. HTTPS/TLS</a></li>
<li><a href="#_path_traversal_protection_2">C.3.3.2.3. Path Traversal Protection</a></li>
<li><a href="#_least_privilege">C.3.3.2.4. Least Privilege</a></li>
</ul>
</li>
<li><a href="#_consequences_3">C.3.3.3. Consequences</a>
<ul class="sectlevel5">
<li><a href="#_positive_3">C.3.3.3.1. Positive</a></li>
<li><a href="#_negative_3">C.3.3.3.2. Negative</a></li>
<li><a href="#_mitigation">C.3.3.3.3. Mitigation</a></li>
<li><a href="#_implementation_2">C.3.3.3.4. Implementation</a></li>
</ul>
</li>
<li><a href="#_future_improvements">C.3.3.4. Future Improvements</a></li>
</ul>
</li>
<li><a href="#_adr_003_led_event_queue_pattern">C.3.4. ADR-003: LED Event Queue Pattern</a>
<ul class="sectlevel4">
<li><a href="#_context_4">C.3.4.1. Context</a></li>
<li><a href="#_decision_4">C.3.4.2. Decision</a></li>
<li><a href="#_consequences_4">C.3.4.3. Consequences</a>
<ul class="sectlevel5">
<li><a href="#_positive_direct_calls_current">C.3.4.3.1. Positive - Direct Calls (Current)</a></li>
<li><a href="#_negative_direct_calls_current">C.3.4.3.2. Negative - Direct Calls (Current)</a></li>
<li><a href="#_positive_event_queue_future">C.3.4.3.3. Positive - Event Queue (Future)</a></li>
<li><a href="#_negative_event_queue_future">C.3.4.3.4. Negative - Event Queue (Future)</a></li>
</ul>
</li>
<li><a href="#_implementation_plan">C.3.4.4. Implementation Plan</a></li>
<li><a href="#_technical_details">C.3.4.5. Technical Details</a>
<ul class="sectlevel5">
<li><a href="#_event_types">C.3.4.5.1. Event Types</a></li>
<li><a href="#_led_row_assignment">C.3.4.5.2. LED Row Assignment</a></li>
<li><a href="#_benefits">C.3.4.5.3. Benefits</a></li>
</ul>
</li>
<li><a href="#_led_test_interface">C.3.4.6. LED Test Interface</a></li>
<li><a href="#_references_2">C.3.4.7. References</a></li>
</ul>
</li>
<li><a href="#_adr_004_battery_monitoring_architecture">C.3.5. ADR-004: Battery Monitoring Architecture</a>
<ul class="sectlevel4">
<li><a href="#_context_5">C.3.5.1. Context</a></li>
<li><a href="#_decision_5">C.3.5.2. Decision</a>
<ul class="sectlevel5">
<li><a href="#_thresholds">C.3.5.2.1. Thresholds</a></li>
<li><a href="#_shutdown_sequence">C.3.5.2.2. Shutdown Sequence</a></li>
</ul>
</li>
<li><a href="#_consequences_5">C.3.5.3. Consequences</a>
<ul class="sectlevel5">
<li><a href="#_positive_4">C.3.5.3.1. Positive</a></li>
<li><a href="#_negative_4">C.3.5.3.2. Negative</a></li>
<li><a href="#_implementation_3">C.3.5.3.3. Implementation</a></li>
</ul>
</li>
<li><a href="#_integration_points">C.3.5.4. Integration Points</a></li>
<li><a href="#_safety_considerations">C.3.5.5. Safety Considerations</a></li>
<li><a href="#_current_status">C.3.5.6. Current Status</a></li>
</ul>
</li>
<li><a href="#_adr_005_multi_camera_source_management">C.3.6. ADR-005: Multi-Camera Source Management</a>
<ul class="sectlevel4">
<li><a href="#_context_6">C.3.6.1. Context</a></li>
<li><a href="#_decision_6">C.3.6.2. Decision</a>
<ul class="sectlevel5">
<li><a href="#_detection_strategy">C.3.6.2.1. Detection Strategy</a></li>
<li><a href="#_switching_approaches">C.3.6.2.2. Switching Approaches</a></li>
</ul>
</li>
<li><a href="#_consequences_6">C.3.6.3. Consequences</a>
<ul class="sectlevel5">
<li><a href="#_positive_deferred">C.3.6.3.1. Positive - Deferred</a></li>
<li><a href="#_negative_deferred">C.3.6.3.2. Negative - Deferred</a></li>
<li><a href="#_positive_when_implemented">C.3.6.3.3. Positive - When Implemented</a></li>
<li><a href="#_negative_when_implemented">C.3.6.3.4. Negative - When Implemented</a></li>
</ul>
</li>
<li><a href="#_implementation_plan_2">C.3.6.4. Implementation Plan</a></li>
<li><a href="#_stream_deck_interface">C.3.6.5. Stream Deck Interface</a>
<ul class="sectlevel5">
<li><a href="#_features">C.3.6.5.1. Features</a></li>
<li><a href="#_ui_layout">C.3.6.5.2. UI Layout</a></li>
</ul>
</li>
<li><a href="#_configuration_2">C.3.6.6. Configuration</a></li>
<li><a href="#_led_integration">C.3.6.7. LED Integration</a></li>
<li><a href="#_current_status_2">C.3.6.8. Current Status</a></li>
</ul>
</li>
<li><a href="#_adr_006_directory_structure">C.3.7. ADR-006: Directory Structure</a>
<ul class="sectlevel4">
<li><a href="#_context_7">C.3.7.1. Context</a></li>
<li><a href="#_decision_7">C.3.7.2. Decision</a></li>
<li><a href="#_consequences_7">C.3.7.3. Consequences</a>
<ul class="sectlevel5">
<li><a href="#_positive_5">C.3.7.3.1. Positive</a></li>
</ul>
</li>
<li><a href="#_rationale">C.3.7.4. Rationale</a></li>
</ul>
</li>
<li><a href="#_adr_007_privileged_container_mode_removal">C.3.8. ADR-007: Privileged Container Mode Removal</a>
<ul class="sectlevel4">
<li><a href="#_context_8">C.3.8.1. Context</a></li>
<li><a href="#_decision_8">C.3.8.2. Decision</a></li>
<li><a href="#_consequences_8">C.3.8.3. Consequences</a>
<ul class="sectlevel5">
<li><a href="#_positive_6">C.3.8.3.1. Positive</a></li>
<li><a href="#_negative_5">C.3.8.3.2. Negative</a></li>
</ul>
</li>
<li><a href="#_host_configuration_required">C.3.8.4. Host Configuration Required</a></li>
<li><a href="#_capabilities_considered">C.3.8.5. Capabilities Considered</a></li>
<li><a href="#_shutdown_capability">C.3.8.6. Shutdown Capability</a></li>
<li><a href="#_testing_results">C.3.8.7. Testing Results</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_description">1. Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Docker container setup for streaming USB microscope camera via web interface on Raspberry Pi Zero.</p>
</div>
<div class="ulist">
<div class="title">Why?</div>
<ul>
<li>
<p>Had a few zeros hanging around (one used here for now)</p>
</li>
<li>
<p>had a camera on a microscope (USB and HDMI)</p>
</li>
<li>
<p>have some assorted pi cameras too (one with night vision)</p>
</li>
<li>
<p>wanted web interface for easy access</p>
</li>
<li>
<p>had a led hat for status display</p>
</li>
<li>
<p>battery is there so why not use it</p>
</li>
<li>
<p>have some other cameras too (HDMI)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>What this is not designed to do is to be the go to interface for working with the stereo microscope. Looking through, live, beats using a latency plagued USB/HDMI/Whatever abstraction layer. This is an augmentation to assist and not take over. HDMI still beats the pi zero for live viewing by a long way.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quick_start">2. Quick Start</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For fully automated setup, run the one-click script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./run-me-first.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will:
- Prompt for your Pi hostname/IP
- Set up SSH access (generate keys and copy if needed)
- Copy required files to Pi
- Run comprehensive testing and container build</p>
</div>
<div class="paragraph">
<p>Manual steps if preferred:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Copy <code>prep-scripts</code> and <code>docker</code> directories to your Raspberry Pi:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">scp <span class="nt">-r</span> prep-scripts docker user@pi-host:~/</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the comprehensive test script to install dependencies and verify hardware:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">ssh user@pi-host
<span class="nb">cd </span>prep-scripts
./comprehensive-test.sh</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start the microscope camera service:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">cd</span> ../docker/docker-microscope
<span class="nb">sudo </span>docker-compose up <span class="nt">-d</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Access the web interface at <code><a href="https://&lt;pi-ip&gt;:8443" class="bare">https://&lt;pi-ip&gt;:8443</a></code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>See detailed setup and configuration instructions below.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hardware_used">3. Hardware used</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Raspberry Pi Zero (or Pi Zero 2)</p>
</li>
<li>
<p>MacroSilicon USB Video device (ID 534d:2109)</p>
</li>
<li>
<p>USB microscope with HDMI output (and USB)</p>
</li>
<li>
<p>HDMI to USB capture adapter</p>
</li>
<li>
<p>Pimoroni Unicorn HAT (4x8 LED matrix) - optional for status display</p>
</li>
<li>
<p>UPS-lite v1.3</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_led_status_display_unicorn_hat">4. LED Status Display (Unicorn HAT)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Pimoroni Unicorn HAT provides visual feedback through a 4x8 LED matrix:</p>
</div>
<div class="sect2">
<h3 id="_row_layout_bottom_to_top">4.1. Row Layout (bottom to top)</h3>
<div class="paragraph">
<p><strong>Row 0 (Bottom)</strong>: System Status</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Green = All systems operational (camera + USB working)
Partial Green = Some systems operational
Off = Systems not ready</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Row 1</strong>: Streaming Status</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Red = Video streaming active
Off = Not streaming</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Rows 2-3 (Top)</strong>: Capture Flash</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Bright White Flash = Image captured successfully
Duration: 0.5 seconds</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_startup_sequence">4.2. Startup Sequence</h3>
<div class="paragraph">
<p>On container start, LEDs animate bottom to top in blue, then show current system status.</p>
</div>
</div>
<div class="sect2">
<h3 id="_error_pattern">4.3. Error Pattern</h3>
<div class="paragraph">
<p>If camera fails to initialize, LEDs flash alternating red rows.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_system_setup">5. System Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>See the included documentation below for detailed setup instructions.</p>
</div>
<div class="sect2">
<h3 id="_pi_zero_status_check">5.1. Pi Zero Status Check</h3>
<div class="listingblock">
<div class="title">Verify system information:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">uname</span> <span class="nt">-a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Output shows ARMv6 architecture:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Linux piz-micoscope 6.12.47+rpt-rpi-v6 #1 Raspbian 1:6.12.47-1+rpt1~bookworm (2025-09-16) armv6l GNU/Linux</pre>
</div>
</div>
<div class="sect3">
<h4 id="_hardware_tests_before_going_full_in">5.1.1. Hardware Tests (before going full in)</h4>
<div class="sect4">
<h5 id="_why_this">5.1.1.1. Why This</h5>
<div class="paragraph">
<p>Verify Pi Zero microscope hardware before container deployment.</p>
</div>
<div class="paragraph">
<p>Tests run on bare Pi. Production uses Docker container.</p>
</div>
<div class="paragraph">
<p>Make sure stuff works. Debug hardware issues early.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The comprehensive test script <code>comprehensive-test.sh</code> automates setup and testing.
IF you are running that then after it you can skip this section unless you run aground.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_why_this_way">5.1.1.2. Why This Way</h5>
<div class="paragraph">
<p>Container uses apt packages (<code>python3-opencv</code>). Pre-compiled. Fast.</p>
</div>
<div class="paragraph">
<p>Pip packages (<code>opencv-python</code>) compile from source. Hours on Pi Zero (I gave up).</p>
</div>
<div class="paragraph">
<p>Solution: Use apt for opencv. Pip for small packages. Venv with system access.</p>
</div>
</div>
<div class="sect4">
<h5 id="_quick_start_2">5.1.1.3. Quick Start</h5>
<div class="paragraph">
<p>Enable hardware:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>raspi-config
<span class="gp">#</span><span class="w"> </span>Interface Options  I2C  Enable
<span class="gp">#</span><span class="w"> </span>Interface Options  SPI  Enable
<span class="gp">#</span><span class="w"> </span>Finish  Reboot</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy prep-scripts and docker to Pi:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>scp <span class="nt">-r</span> prep-scripts docker sean@piz-microscope.fritz.box:~/</code></pre>
</div>
</div>
<div class="paragraph">
<p>On Pi install packages via apt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>apt-get update
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> python3-opencv python3-numpy python3-dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create venv with system packages access:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">cd</span> ~/prep-scripts
<span class="gp">$</span><span class="w"> </span>python3 <span class="nt">-m</span> venv <span class="nt">--system-site-packages</span> ~/test-env
<span class="gp">$</span><span class="w"> </span><span class="nb">source</span> ~/test-env/bin/activate
<span class="gp">$</span><span class="w"> </span>pip <span class="nb">install</span> <span class="nt">--upgrade</span> pip setuptools wheel
<span class="gp">$</span><span class="w"> </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Requirements (requirements.txt):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">smbus2
RPi.GPIO
unicornhat</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test hardware:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">source</span> ~/test-env/bin/activate
<span class="go">
</span><span class="gp">#</span><span class="w"> </span>LED HAT
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo</span> <span class="nt">-E</span> python3 prep-scripts/function-test-hat.py
<span class="go">
</span><span class="gp">#</span><span class="w"> </span>Battery
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo</span> <span class="nt">-E</span> python3 prep-scripts/function-test-battery.py
<span class="go">
</span><span class="gp">#</span><span class="w"> </span>Cameras <span class="o">(</span>USB/CSI<span class="o">)</span>
<span class="gp">$</span><span class="w"> </span>python3 prep-scripts/function-test-cameras.py <span class="nt">--list</span>  <span class="c"># List available cameras</span>
<span class="gp">$</span><span class="w"> </span>python3 prep-scripts/function-test-cameras.py /dev/video0  <span class="c"># Test specific camera</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cleanup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>deactivate
<span class="gp">$</span><span class="w"> </span><span class="nb">rm</span> <span class="nt">-rf</span> ~/test-env ~/prep-scripts</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_hardware_check">5.1.1.4. Hardware Check</h5>
<div class="paragraph">
<p>List USB devices:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>lsusb
<span class="go">Bus 001 Device 002: ID 534d:2109 MacroSilicon USB Video
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>List video devices:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>v4l2-ctl <span class="nt">--list-devices</span>
<span class="go">unicam (platform:20801000.csi):
        /dev/video0

USB Video: USB Video (usb-20980000.usb-1):
        /dev/video1
        /dev/video2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check I2C and SPI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">ls</span> /dev/i2c-<span class="k">*</span> /dev/spi<span class="k">*</span>
<span class="go">/dev/i2c-1  /dev/spidev0.0  /dev/spidev0.1</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_tests">5.1.1.5. Tests</h5>
<div class="sect5">
<h6 id="_led_hat">5.1.1.5.1. LED HAT</h6>
<div class="paragraph">
<p>Pimoroni Unicorn HAT 4x8. Uses SPI.</p>
</div>
<div class="paragraph">
<p>Script: <code>function-test-hat.py</code> - Color sequence test</p>
</div>
<div class="paragraph">
<p>Run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo</span> <span class="nt">-E</span> python3 <span class="k">function</span><span class="nt">-test-hat</span>.py
<span class="go">Unicorn HAT initialized
Test 1: Red row
Test 2: Green row
Test 3: Blue row
Test 4: Yellow row
Test 5: All white
Test complete</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Expected: Rows light red, green, blue, yellow, then all white.</p>
</div>
</div>
<div class="sect5">
<h6 id="_battery">5.1.1.5.2. Battery</h6>
<div class="paragraph">
<p>UPS-Lite v1.3. CW2015 fuel gauge. I2C 0x62.</p>
</div>
<div class="paragraph">
<p>Script: <code>function-test-battery.py</code> - Comprehensive battery testing</p>
</div>
<div class="paragraph">
<p>Device detection, register dump, voltage/capacity reading, status monitoring:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo</span> <span class="nt">-E</span> python3 <span class="k">function</span><span class="nt">-test-battery</span>.py
<span class="go">UPS-Lite v1.3 Battery Monitor Test
I2C Address: 0x62

Test 1: I2C Device Detection
PASS: Device found

Test 2: Register Dump
Register dump (first 16 registers):
  Reg 0x00: 0x00 (0)
</span><span class="c">  ...
</span><span class="go">
Test 3: Single Readings
Voltage: 4.20V
Capacity: 100%
Charging: False

Test 4: Status Summary
Status: FULL
Voltage: 4.20V
Capacity: 100%
Charging: False

Test 5: Continuous Monitoring (Ctrl+C to stop)
Status: FULL | Voltage: 4.20V | Capacity: 100%
</span><span class="c">...</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_camera">5.1.1.5.3. Camera</h6>
<div class="paragraph">
<p>Test USB cameras (MacroSilicon HDMI capture) and CSI cameras (onboard Pi camera).</p>
</div>
<div class="paragraph">
<p>Script: <code>test-camera.py</code> - Unified camera testing</p>
</div>
<div class="paragraph">
<p>List available cameras:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>python3 test-camera.py <span class="nt">--list</span>
<span class="go">Available video devices:
/dev/video0: CSI camera (640x480 @ 30fps)
/dev/video1: USB camera (1280x720 @ 30fps)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Test all cameras:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>python3 test-camera.py
<span class="go">Testing camera: /dev/video0
Resolution: 640x480
FPS: 30.0
SUCCESS: Captured test-video0.jpg

Testing camera: /dev/video1
Resolution: 1280x720
FPS: 30.0
SUCCESS: Captured test-video1.jpg</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Test specific camera:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>python3 test-camera.py /dev/video1
<span class="go">Testing camera: /dev/video1
Resolution: 1280x720
FPS: 30.0
SUCCESS: Captured test-video1.jpg</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_troubleshooting">5.1.1.6. Troubleshooting</h5>
<div class="paragraph">
<p>I2C missing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">ls</span> /dev/i2c-<span class="k">*</span>
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>i2cdetect <span class="nt">-y</span> 1  <span class="c"># Battery at 0x62</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>SPI missing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">ls</span> /dev/spi<span class="k">*</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Import errors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">source</span> ~/test-env/bin/activate
<span class="gp">$</span><span class="w"> </span>python3 <span class="nt">-c</span> <span class="s2">"import cv2; print(cv2.__version__)"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>GPIO busy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>docker stop microscope-camera</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_notes">5.1.1.7. Notes</h5>
<div class="paragraph">
<p><code>sudo -E</code> preserves venv.</p>
</div>
<div class="paragraph">
<p><code>--system-site-packages</code> lets venv use apt opencv while keeping pip packages isolated.</p>
</div>
<div class="paragraph">
<p>Tests verify hardware only. Container handles production. Two different beasts. This is only foundation.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_access_web_interface">6. Access Web Interface</h2>
<div class="sectionbody">
<div class="ulist">
<div class="title">Open browser on same network:</div>
<ul>
<li>
<p><a href="https://&lt;pi-zero-ip&gt;:8443" class="bare">https://&lt;pi-zero-ip&gt;:8443</a></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Stream endpoint:</div>
<ul>
<li>
<p><a href="https://&lt;pi-zero-ip&gt;:8443/?action=stream" class="bare">https://&lt;pi-zero-ip&gt;:8443/?action=stream</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration">7. Configuration</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">Edit environment variables in <code>docker-compose.yml</code>:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">environment</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">VIDEO_DEVICE=/dev/video0</span>    <span class="c1"># USB device path</span>
  <span class="pi">-</span> <span class="s">VIDEO_WIDTH=1280</span>            <span class="c1"># Resolution width</span>
  <span class="pi">-</span> <span class="s">VIDEO_HEIGHT=720</span>            <span class="c1"># Resolution height</span>
  <span class="pi">-</span> <span class="s">VIDEO_FPS=30</span>                <span class="c1"># Frames per second</span>
  <span class="pi">-</span> <span class="s">WEB_PORT=8443</span>               <span class="c1"># Web interface port</span>
  <span class="pi">-</span> <span class="s">ENABLE_LEDS=true</span>            <span class="c1"># Enable Unicorn HAT display</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">To disable LED display (if no Unicorn HAT):</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml">  <span class="pi">-</span> <span class="s">ENABLE_LEDS=false</span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Common resolutions for microscope cameras:</div>
<ul>
<li>
<p>640x480 @ 30fps (default, lowest latency)</p>
</li>
<li>
<p>1280x720 @ 30fps (HD quality)</p>
</li>
<li>
<p>1920x1080 @ 15fps (Full HD, lower fps)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_troubleshooting_2">8. Troubleshooting</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_armv6_vs_armv7_architecture_error">8.1. ARMv6 vs ARMv7 Architecture Error</h3>
<div class="listingblock">
<div class="title">Pi Zero uses ARMv6. If you see platform mismatch warnings:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">[Warning] The requested image's platform (linux/arm/v7) does not match
the detected host platform (linux/arm/v6)</span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Solution:</div>
<ul>
<li>
<p>Dockerfile now uses <code>balenalib/raspberry-pi-debian</code> which supports ARMv6.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_build_fails_with_code_139">8.2. Build Fails with Code 139</h3>
<div class="ulist">
<div class="title">Segmentation fault during build. potentially caused by:</div>
<ul>
<li>
<p>Wrong base image architecture</p>
</li>
<li>
<p>Out of memory during compilation</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Solution:</div>
<ul>
<li>
<p>Use the updated Dockerfile with minimal dependencies and pre-built packages.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_device_not_found">8.3. Device Not Found</h3>
<div class="listingblock">
<div class="title">Check USB device permissions:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">ls</span> <span class="nt">-la</span> /dev/video0
<span class="nb">sudo chmod </span>666 /dev/video0</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Add user to video group:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>usermod <span class="nt">-aG</span> video <span class="nv">$USER</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_unsupported_format">8.4. Unsupported Format</h3>
<div class="listingblock">
<div class="title">List supported formats:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">v4l2-ctl <span class="nt">--device</span><span class="o">=</span>/dev/video0 <span class="nt">--list-formats-ext</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Adjust resolution in <code>docker-compose.yml</code> to match supported format.</p>
</div>
</div>
<div class="sect2">
<h3 id="_container_fails_to_start">8.5. Container Fails to Start</h3>
<div class="listingblock">
<div class="title">Check container logs:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker-compose logs microscope</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Rebuild container:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker-compose down
docker-compose build <span class="nt">--no-cache</span>
docker-compose up <span class="nt">-d</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_container_permissions">8.6. Container Permissions</h3>
<div class="paragraph">
<p>Container runs with privileged mode (ran with) and has access to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/dev/video0</code> - USB video device</p>
</li>
<li>
<p><code>/dev/gpiomem</code> - GPIO memory for LED control</p>
</li>
<li>
<p><code>/dev/spidev0.0</code> - SPI interface for Unicorn HAT</p>
</li>
<li>
<p><code>/sys</code> - System files (read-only) for hardware detection</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These permissions allow the container to control the Unicorn HAT LEDs and access the USB camera.</p>
</div>
</div>
<div class="sect2">
<h3 id="_low_performance_on_pi_zero_if_you_hit_that">8.7. Low Performance on Pi Zero (if you hit that)</h3>
<div class="paragraph">
<p>Pi Zero (ARMv6) has limited CPU. Reduce resolution and framerate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">environment</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">VIDEO_WIDTH=320</span>
  <span class="pi">-</span> <span class="s">VIDEO_HEIGHT=240</span>
  <span class="pi">-</span> <span class="s">VIDEO_FPS=15</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_leds_not_working">8.8. LEDs Not Working</h3>
<div class="paragraph">
<p>Check Unicorn HAT is properly connected and SPI is enabled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">ls</span> <span class="nt">-la</span> /dev/spidev0.0
<span class="c"># Should show: crw-rw---- 1 root spi</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Enable SPI if needed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>raspi-config
<span class="c"># Interface Options -&gt; SPI -&gt; Enable</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check container has device access:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>docker <span class="nb">exec </span>microscope-camera <span class="nb">ls</span> <span class="nt">-la</span> /dev/spidev0.0 /dev/gpiomem</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_multiple_video_devices">8.9. Multiple Video Devices</h3>
<div class="paragraph">
<p>If multiple video devices exist, specify correct device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">v4l2-ctl <span class="nt">--list-devices</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Update <code>VIDEO_DEVICE</code> environment variable accordingly.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pi_zero_microscope_setup">9. Pi Zero Microscope Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Fresh Raspberry Pi OS setup to production deployment.</p>
</div>
<div class="sect2">
<h3 id="_buildrebuild">9.1. Build/Rebuild</h3>
<div class="olist arabic">
<div class="title">To rebuild from scratch:</div>
<ol class="arabic">
<li>
<p>Flash fresh Raspberry Pi OS</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Configure WiFi and user (in the step above with RPI imager)</p>
</li>
</ol>
</div>
</li>
<li>
<p>Follow this document</p>
</li>
<li>
<p>Deploy container</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>No manual package installation.
No system package breaking.
Reproducible deployment.</p>
</div>
</div>
<div class="sect2">
<h3 id="_initial_setup">9.2. Initial Setup</h3>
<div class="paragraph">
<p>Fresh Raspberry Pi OS Lite installed.
WiFi configured.
User <code>sean</code> created.</p>
</div>
<div class="paragraph">
<p>Hostname: <code>piz-microscope</code></p>
</div>
<div class="paragraph">
<p>SSH from workstation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">ssh-copy-id sean@piz-microscope.fritz.box
ssh sean@piz-microscope.fritz.box</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_enable_hardware_interfaces">9.3. Enable Hardware Interfaces</h3>
<div class="listingblock">
<div class="title">Enable I2C and SPI for hardware access.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>raspi-config</code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Steps:</div>
<ol class="arabic">
<li>
<p>Interface Options  I2C  Enable</p>
</li>
<li>
<p>Interface Options  SPI  Enable</p>
</li>
<li>
<p>Finish  Reboot</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Verify:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">ls</span> /dev/i2c-<span class="k">*</span> /dev/spi<span class="k">*</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Expected:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">/dev/i2c-1
/dev/spidev0.0
/dev/spidev0.1</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_install_docker">9.4. Install Docker</h3>
<div class="paragraph">
<p>Docker provides container runtime.
No application packages on host.</p>
</div>
<div class="listingblock">
<div class="title">Install Docker:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="nt">-fsSL</span> https://get.docker.com <span class="nt">-o</span> get-docker.sh
<span class="nb">sudo </span>sh get-docker.sh
<span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker sean</code></pre>
</div>
</div>
<div class="paragraph">
<p>Logout and login to apply group.</p>
</div>
<div class="listingblock">
<div class="title">Verify:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker <span class="nt">--version</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_install_docker_compose">9.5. Install Docker Compose</h3>
<div class="listingblock">
<div class="title">Install Docker Compose:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>docker-compose</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Verify:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker-compose <span class="nt">--version</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_environment_configuration">9.6. Environment Configuration</h3>
<div class="paragraph">
<p>Configuration via <code>.env</code> file.</p>
</div>
<div class="sect3">
<h4 id="_setup">9.6.1. Setup</h4>
<div class="paragraph">
<p>Copy example file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">cd </span>docker
<span class="nb">cp</span> .env.example .env</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit <code>.env</code> with your values.</p>
</div>
</div>
<div class="sect3">
<h4 id="_required_changes">9.6.2. Required Changes</h4>
<div class="paragraph">
<p>Change authentication credentials:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">WEB_USERNAME</span><span class="o">=</span>your_username
<span class="nv">WEB_PASSWORD</span><span class="o">=</span>your_secure_password</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_variables">9.6.3. Configuration Variables</h4>
<div class="sect4">
<h5 id="_camera_2">9.6.3.1. Camera</h5>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>VIDEO_DEVICE=/dev/video1
VIDEO_WIDTH=1280
VIDEO_HEIGHT=720
VIDEO_FPS=30</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_web_server">9.6.3.2. Web Server</h5>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>WEB_PORT=8080
ENABLE_HTTPS=true</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_authentication">9.6.3.3. Authentication</h5>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>WEB_USERNAME=admin
WEB_PASSWORD=your_secure_password_here</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_hardware">9.6.3.4. Hardware</h5>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>ENABLE_LEDS=true
ENABLE_BATTERY_MONITOR=true</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_battery_2">9.6.3.5. Battery</h5>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>BATTERY_LOW_THRESHOLD=20
BATTERY_CRITICAL_THRESHOLD=10</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deployment">9.6.4. Deployment</h4>
<div class="paragraph">
<p>Docker Compose reads <code>.env</code> automatically.</p>
</div>
<div class="paragraph">
<p>Start service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">cd </span>docker
docker-compose up <span class="nt">-d</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Variables passed to container.
Defaults used if not set.</p>
</div>
</div>
<div class="sect3">
<h4 id="_security">9.6.5. Security</h4>
<div class="paragraph">
<p><code>.env</code> file contains credentials.
Never commit to git.
Added to <code>.gitignore</code>.</p>
</div>
<div class="paragraph">
<p>Share <code>.env.example</code> instead.
Each deployment creates own <code>.env</code>.</p>
</div>
<div class="paragraph">
<p>Backup <code>.env</code> securely.
Rotate credentials regularly.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_application">9.7. Deploy Application</h3>
<div class="listingblock">
<div class="title">Copy project to Pi:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">scp <span class="nt">-r</span> docker sean@piz-microscope.fritz.box:~/</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">On Pi:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">cd </span>docker
<span class="nb">sudo </span>docker-compose up <span class="nt">-d</span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Access web interface:</div>
<ul>
<li>
<p><a href="https://piz-microscope.fritz.box:8080" class="bare">https://piz-microscope.fritz.box:8080</a> (HTTPS with self-signed cert)</p>
</li>
<li>
<p><a href="https://piz-microscope.fritz.box:8443" class="bare">https://piz-microscope.fritz.box:8443</a> (HTTPS primary)</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Default credentials:</div>
<ul>
<li>
<p>Username: admin</p>
</li>
<li>
<p>Password: changeme_generate_secure_password (change in .env)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_security_configuration">9.8. Security Configuration</h3>
<div class="paragraph">
<p>Security features implemented in microscope system.</p>
</div>
<div class="sect3">
<h4 id="_authentication_2">9.8.1. Authentication</h4>
<div class="paragraph">
<p>Basic HTTP authentication protects all endpoints.
Health endpoint remains unauthenticated for monitoring.</p>
</div>
<div class="sect4">
<h5 id="_credentials">9.8.1.1. Credentials</h5>
<div class="paragraph">
<p>Configure in <code>.env</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">WEB_USERNAME</span><span class="o">=</span>admin
<span class="nv">WEB_PASSWORD</span><span class="o">=</span>your_secure_password_here</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy example file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">cd </span>docker
<span class="nb">cp</span> .env.example .env</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit credentials in <code>.env</code>.</p>
</div>
<div class="paragraph">
<p>Default username: <code>admin</code>
Default password: <code>changeme_generate_secure_password</code></p>
</div>
<div class="paragraph">
<p>Change before deployment.
Never commit <code>.env</code> to git.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_httpstls">9.8.2. HTTPS/TLS</h4>
<div class="paragraph">
<p>Self-signed certificate generated during build.
Valid for 365 days.</p>
</div>
<div class="sect4">
<h5 id="_certificate_details">9.8.2.1. Certificate Details</h5>
<div class="paragraph">
<p>Location: <code>/app/certs/</code>
Files: <code>cert.pem</code>, <code>key.pem</code></p>
</div>
<div class="paragraph">
<p>Certificate info:
- Country: DE
- Organization: VSaGCR
- Common Name: microscope.local</p>
</div>
</div>
<div class="sect4">
<h5 id="_disable_https">9.8.2.2. Disable HTTPS</h5>
<div class="paragraph">
<p>Set in <code>.env</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">ENABLE_HTTPS</span><span class="o">=</span><span class="nb">false</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_path_traversal_protection">9.8.3. Path Traversal Protection</h4>
<div class="paragraph">
<p>All file operations validate paths.
Only files in <code>/app/captures</code> accessible.</p>
</div>
<div class="paragraph">
<p>Validation uses <code>filepath.resolve().is_relative_to()</code>.
Invalid paths rejected with 400 error.</p>
</div>
</div>
<div class="sect3">
<h4 id="_privileged_mode_removed">9.8.4. Privileged Mode Removed</h4>
<div class="paragraph">
<p>Container runs without privileged mode.
Specific device access only.</p>
</div>
<div class="paragraph">
<p>Devices mapped:
- <code>/dev/video1</code> - Camera
- <code>/dev/gpiomem</code> - GPIO
- <code>/dev/spidev0.0</code> - SPI
- <code>/dev/i2c-1</code> - I2C</p>
</div>
</div>
<div class="sect3">
<h4 id="_health_check">9.8.5. Health Check</h4>
<div class="paragraph">
<p>Path: <code>/health</code></p>
</div>
<div class="paragraph">
<p>Unauthenticated endpoint for monitoring.
Returns 200 if camera operational.
Returns 503 if camera error.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl https://localhost:8443/health</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_protected_endpoints">9.8.6. Protected Endpoints</h4>
<div class="paragraph">
<p>All require authentication:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/</code> - Main interface</p>
</li>
<li>
<p><code>/stream</code> - Video feed</p>
</li>
<li>
<p><code>/capture</code> - Image capture</p>
</li>
<li>
<p><code>/status</code> - System status</p>
</li>
<li>
<p><code>/captures</code> - List images</p>
</li>
<li>
<p><code>/captures/&lt;filename&gt;</code> - Get image</p>
</li>
<li>
<p><code>/batch/download</code> - Batch download</p>
</li>
<li>
<p><code>/batch/delete</code> - Batch delete</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_recommendations">9.8.7. Recommendations</h4>
<div class="paragraph">
<p>Store credentials in <code>.env</code> file.
File excluded from git via <code>.gitignore</code>.</p>
</div>
<div class="paragraph">
<p>Generate strong password:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">python3 <span class="nt">-c</span> <span class="s2">"import secrets; print(secrets.token_urlsafe(32))"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Update <code>.env</code> with generated password.</p>
</div>
<div class="paragraph">
<p>Use reverse proxy for production.
Terminate TLS with valid certificate.
Add rate limiting.</p>
</div>
</div>
<div class="sect3">
<h4 id="_file_security">9.8.8. File Security</h4>
<div class="paragraph">
<p><code>.env</code> contains sensitive credentials.
Never commit to version control.
Added to <code>.gitignore</code> automatically.</p>
</div>
<div class="paragraph">
<p>Share <code>.env.example</code> instead.
Each deployment creates own <code>.env</code>.</p>
</div>
<div class="paragraph">
<p>Backup <code>.env</code> file securely.
Rotate credentials regularly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_known_limitations">9.8.9. Known Limitations</h4>
<div class="paragraph">
<p>Self-signed certificate triggers browser warnings.
Accept certificate or add to trusted store.</p>
</div>
<div class="paragraph">
<p>No password complexity requirements.
No account lockout mechanism.
No audit logging.</p>
</div>
<div class="paragraph">
<p>Plan proper authentication system for production.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_verify_hardware">9.9. Verify Hardware</h3>
<div class="paragraph">
<p>Container runs tests on startup.</p>
</div>
<div class="listingblock">
<div class="title">Check logs:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>docker logs microscope-camera</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Expected:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">Unicorn HAT initialized successfully
CW2015 battery monitor initialized
Camera /dev/video1 opened</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_host_state">9.10. Host State</h3>
<div class="ulist">
<div class="title">After setup, host has:</div>
<ul>
<li>
<p>Docker installed</p>
</li>
<li>
<p>I2C enabled</p>
</li>
<li>
<p>SPI enabled</p>
</li>
<li>
<p>User in docker group</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Host does NOT have:</div>
<ul>
<li>
<p>Python packages</p>
</li>
<li>
<p>Application code (only in container)</p>
</li>
<li>
<p>Manual dependencies</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Clean host. Container has everything.</p>
</div>
</div>
<div class="sect2">
<h3 id="_planned_features_not_yet_implemented">9.11. Planned Features Not Yet Implemented</h3>
<div class="paragraph">
<p>Features designed in architecture but not implemented.
See ADRs for detailed specifications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ADR-003: LED Event Queue Pattern</p>
</li>
<li>
<p>ADR-004: Battery Monitoring Architecture</p>
</li>
<li>
<p>ADR-005: Multi-Camera Source Management</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_current_implementation_status">9.11.1. Current Implementation Status</h4>
<div class="ulist">
<ul>
<li>
<p>Battery monitoring module exists but not integrated</p>
</li>
<li>
<p>Event queue architecture designed but not implemented</p>
</li>
<li>
<p>Multi-camera support planned but single camera only</p>
</li>
<li>
<p>LED admin interface designed but endpoint missing</p>
</li>
<li>
<p>Stream deck UI mockup created but not built</p>
</li>
<li>
<p>Health endpoint referenced but not implemented</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_implementation_priority">9.11.2. Implementation Priority</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Fix security issues first </p>
</li>
<li>
<p>Add health endpoint for monitoring</p>
</li>
<li>
<p>Integrate battery monitoring</p>
</li>
<li>
<p>Implement event queue pattern</p>
</li>
<li>
<p>Add multi-camera support</p>
</li>
<li>
<p>Build admin interface</p>
</li>
<li>
<p>Create stream deck UI</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_security_fixes_and_improvements_applied">9.12. Security Fixes and Improvements Applied</h3>
<div class="paragraph">
<p>Security vulnerabilities fixed.
All changes documented.</p>
</div>
<div class="sect3">
<h4 id="_critical_fixes">9.12.1. Critical Fixes</h4>
<div class="sect4">
<h5 id="_path_traversal_vulnerability">9.12.1.1. Path Traversal Vulnerability</h5>
<div class="paragraph">
<p><strong>Issue:</strong> <code>batch_delete()</code> and file operations accepted user filenames without validation.</p>
</div>
<div class="paragraph">
<p><strong>Fix:</strong> All file operations now validate paths using <code>filepath.resolve().is_relative_to()</code>.</p>
</div>
<div class="paragraph">
<p>Files:
* <code>docker/docker-microscope/web_server.py</code></p>
</div>
<div class="paragraph">
<p>Endpoints protected:
* <code>/captures/&lt;filename&gt;</code>
* <code>/batch/download</code>
* <code>/batch/delete</code></p>
</div>
</div>
<div class="sect4">
<h5 id="_authentication_added">9.12.1.2. Authentication Added</h5>
<div class="paragraph">
<p><strong>Issue:</strong> No authentication on any endpoint.</p>
</div>
<div class="paragraph">
<p><strong>Fix:</strong> Basic HTTP authentication on all endpoints except health check.</p>
</div>
<div class="paragraph">
<p>Configuration:
* Username: <code>WEB_USERNAME</code> environment variable
* Password: <code>WEB_PASSWORD</code> environment variable</p>
</div>
<div class="paragraph">
<p>Protected endpoints:
* <code>/</code> - Main interface
* <code>/stream</code> - Video feed
* <code>/capture</code> - Image capture
* <code>/status</code> - System status
* <code>/captures</code> - List images
* All batch operations</p>
</div>
</div>
<div class="sect4">
<h5 id="_https_support">9.12.1.3. HTTPS Support</h5>
<div class="paragraph">
<p><strong>Issue:</strong> Unencrypted HTTP traffic.</p>
</div>
<div class="paragraph">
<p><strong>Fix:</strong> Self-signed certificate generated during build.</p>
</div>
<div class="paragraph">
<p>Files modified:
* <code>docker/docker-microscope/Dockerfile</code> - Certificate generation
* <code>docker/docker-microscope/web_server.py</code> - SSL context handling</p>
</div>
<div class="paragraph">
<p>Configuration:
* <code>ENABLE_HTTPS</code> environment variable
* Certificate path: <code>/app/certs/</code></p>
</div>
</div>
<div class="sect4">
<h5 id="_privileged_mode_removed_2">9.12.1.4. Privileged Mode Removed</h5>
<div class="paragraph">
<p><strong>Issue:</strong> Container ran with <code>privileged: true</code>.</p>
</div>
<div class="paragraph">
<p><strong>Fix:</strong> Removed privileged mode from compose file.</p>
</div>
<div class="paragraph">
<p>Files:
* <code>docker/docker-compose.yml</code></p>
</div>
<div class="paragraph">
<p>Container now uses specific device mappings only.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_changes">9.12.2. Configuration Changes</h4>
<div class="sect4">
<h5 id="_environment_variables_centralized">9.12.2.1. Environment Variables Centralized</h5>
<div class="paragraph">
<p>All configuration moved to <code>docker-compose.yml</code>.</p>
</div>
<div class="paragraph">
<p>Variables added:
* <code>WEB_USERNAME</code> - Default: admin
* <code>WEB_PASSWORD</code> - Default: changeme_generate_secure_password
* <code>ENABLE_HTTPS</code> - Default: true
* <code>BATTERY_LOW_THRESHOLD</code> - Default: 20
* <code>BATTERY_CRITICAL_THRESHOLD</code> - Default: 10</p>
</div>
</div>
<div class="sect4">
<h5 id="_health_check_added">9.12.2.2. Health Check Added</h5>
<div class="paragraph">
<p>Endpoint: <code>/health</code></p>
</div>
<div class="paragraph">
<p>Unauthenticated for monitoring systems.
Returns 200 if camera operational.
Returns 503 if camera error.</p>
</div>
<div class="paragraph">
<p>Docker healthcheck configured in compose file.</p>
</div>
</div>
<div class="sect4">
<h5 id="_ports_updated">9.12.2.3. Ports Updated</h5>
<div class="paragraph">
<p>Exposed ports:
* 8080 - HTTP/HTTPS web interface
* 8443 - Additional HTTPS port</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_documentation_created">9.12.3. Documentation Created</h4>
<div class="sect4">
<h5 id="_new_files">9.12.3.1. New Files</h5>
<div class="paragraph">
<p><code>docker/PLANNED_FEATURES.adoc</code>
* Lists unimplemented features from architecture
* Battery monitoring integration
* Event queue system
* Multi-camera switching
* LED admin interface
* Stream deck interface</p>
</div>
<div class="paragraph">
<p><code>docker/SECURITY.adoc</code>
* Security configuration guide
* Authentication setup
* HTTPS configuration
* Path protection details
* Recommendations</p>
</div>
<div class="paragraph">
<p><code>adr/adr-002-security-model.adoc</code>
* Architecture decision record
* Security model rationale
* Implementation details
* Trade-offs documented</p>
</div>
</div>
<div class="sect4">
<h5 id="_updated_files">9.12.3.2. Updated Files</h5>
<div class="paragraph">
<p><code>docker/README.adoc</code>
* Updated deployment instructions
* Added authentication details
* Fixed paths after restructure</p>
</div>
<div class="paragraph">
<p><code>include-setup.adoc</code>
* Fixed file structure documentation
* Removed references to nonexistent examples directory
* Content consolidated into main <code>README.asciidoc</code></p>
</div>
<div class="paragraph">
<p><code>prep-scripts/README.adoc</code>
* Fixed test deployment paths</p>
</div>
<div class="paragraph">
<p><code>adr/README.adoc</code>
* Added ADR-002 include</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_files_modified">9.12.4. Files Modified</h4>
<div class="sect4">
<h5 id="_core_application">9.12.4.1. Core Application</h5>
<div class="paragraph">
<p><code>docker/docker-microscope/web_server.py</code>
* Added authentication system
* Added HTTPS support
* Fixed path traversal vulnerabilities
* Added health endpoint
* Environment-based configuration</p>
</div>
<div class="paragraph">
<p><code>docker/docker-microscope/Dockerfile</code>
* Added openssl package
* Generate self-signed certificate
* Expose port 8443</p>
</div>
<div class="paragraph">
<p><code>docker/docker-microscope/docker_entrypoint.sh</code>
* Use VIDEO_DEVICE from environment consistently
* Remove hardcoded /dev/video0 references</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deployment_changes">9.12.5. Deployment Changes</h4>
<div class="paragraph">
<p>Default password must be changed.
Generate secure password before deployment.</p>
</div>
<div class="paragraph">
<p>Access interface at:
* <a href="https://hostname:8080" class="bare">https://hostname:8080</a> (HTTPS)
* <a href="https://hostname:8443" class="bare">https://hostname:8443</a> (HTTPS primary)</p>
</div>
<div class="paragraph">
<p>Browser shows certificate warning.
Accept self-signed certificate or add to trusted store.</p>
</div>
</div>
<div class="sect3">
<h4 id="_security_recommendations">9.12.6. Security Recommendations</h4>
<div class="paragraph">
<p>Change default password in compose file.
Use reverse proxy for production.
Terminate TLS with valid certificate.
Add rate limiting at proxy level.</p>
</div>
<div class="paragraph">
<p>Generate password:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">python3 <span class="nt">-c</span> <span class="s2">"import secrets; print(secrets.token_urlsafe(32))"</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing">9.12.7. Testing</h4>
<div class="paragraph">
<p>Test authentication:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="nt">-u</span> admin:password https://hostname:8080/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test health endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl https://hostname:8443/health</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test path traversal protection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="nt">-u</span> admin:password https://hostname:8080/captures/../etc/passwd
<span class="c"># Should return 400 Bad Request</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_next_steps">9.12.8. Next Steps</h4>
<div class="paragraph">
<p>Security fixes complete.
System ready for deployment.</p>
</div>
<div class="paragraph">
<p>Consider:
* Deploy and test authentication
* Generate production password
* Set up reverse proxy
* Monitor health endpoint
* Review security documentation</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">Appendix A: References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/jacksonliam/mjpg-streamer">mjpg-streamer GitHub</a></p>
</li>
<li>
<p><a href="https://www.kernel.org/doc/html/latest/userspace-api/media/v4l/v4l2.html">Video4Linux2 API</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_images">Appendix B: images</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_images_2">B.1. Images</h3>
<div class="sect3">
<h4 id="_here_the_overall_idea">B.1.1. here the overall idea</h4>
<div class="paragraph">
<p>:
.Architecture
image::./architecture.svg[]</p>
</div>
</div>
<div class="sect3">
<h4 id="_captures_from_the_scope">B.1.2. Captures from the scope</h4>
<div class="paragraph">
<p>The following images show why it might not be bad to have different cameras connected to a pi microscope se
tup even if only one is looking through the scope.
:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s good to have different views and not just close ups all the time.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/capture_20251213_230748.jpg" alt="capture 20251213 230748">
</div>
<div class="title">Figure 1. high magnification RPI (ver 1)</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/capture_20251213_230828.jpg" alt="capture 20251213 230828">
</div>
<div class="title">Figure 2. low magnification RPI (ver 1)</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/capture_20251213_232333.jpg" alt="capture 20251213 232333">
</div>
<div class="title">Figure 3. high magnification RPI connector (ver 1)</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/capture_20251213_233248.jpg" alt="capture 20251213 233248">
</div>
<div class="title">Figure 4. lower magnification RPI connector (ver 1)</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/capture_20251213_233305.jpg" alt="capture 20251213 233305">
</div>
<div class="title">Figure 5. lower still magnification RPI connector (ver 1)</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/capture_20251213_233318.jpg" alt="capture 20251213 233318">
</div>
<div class="title">Figure 6. even lower still magnification RPI connector (ver 1)</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/capture_20251213_233336.jpg" alt="capture 20251213 233336">
</div>
<div class="title">Figure 7. you get the picture</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/capture_20251213_233355.jpg" alt="capture 20251213 233355">
</div>
<div class="title">Figure 8. zoomed out RPI connector (ver 1)</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_project_itself">B.1.3. the project itself</h4>
<div class="imageblock">
<div class="content">
<img src="images/IMG_9386.jpeg" alt="IMG 9386">
</div>
<div class="title">Figure 9. Top view Microscope with camera module</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/IMG_9387.jpeg" alt="IMG 9387">
</div>
<div class="title">Figure 10. looking through the microscope</div>
</div>
<div class="paragraph">
<p>:
.side view with draft rpi zero connected (and attached night vision rpi cam dangling)
image::./IMG_9388.jpeg[]</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/IMG_9389.jpeg" alt="IMG 9389">
</div>
<div class="title">Figure 11. Night vision rpi cam with active lights</div>
</div>
<div class="paragraph">
<p>:
.Lights on if dark
image::./IMG_20251215_004513_656.jpg[]</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/IMG_20251215_004506_307.jpg" alt="IMG 20251215 004506 307">
</div>
<div class="title">Figure 12. Lights off if light enough</div>
</div>
<div class="paragraph">
<p>:
.thermal of the pi cam
image::./1765751852542_100.JPG[]</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>thermal image shows the pi cam getting hot enough to soften a 3d PLA print easily.
Also it&#8217;s not the Cam itself but the board&#8230;&#8203; so BEWARE! (note to self: figure out a better way than printi
ng a plastic mount right next to a heat source)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The heat seems to stem from SMD parts on the infra red "ears".
It may be possible to just take them off and move them further away from the lens board. The rest seems to
be ok for PLA.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/IMG_9390.jpeg" alt="IMG 9390">
</div>
<div class="title">Figure 13. HW stack: unicorn hat, rpi zero, ups-lite v1.3 battery</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/1765751874019_100.JPG" alt="1765751874019 100">
</div>
<div class="title">Figure 14. thermal of HW stack</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/IMG_9391.jpeg" alt="IMG 9391">
</div>
<div class="title">Figure 15. HDMI USB capture device connected to microscope and rpi zero</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_architecture_decision_records">Appendix C: Architecture Decision Records</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_is_an_adr">C.1. What is an ADR</h3>
<div class="paragraph">
<p>Architecture Decision Record captures significant design choices.</p>
</div>
<div class="paragraph">
<p>TOGAF defines ADRs as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Document key architectural decisions</p>
</li>
<li>
<p>Record context and rationale</p>
</li>
<li>
<p>Track consequences</p>
</li>
<li>
<p>Enable future understanding</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_format">C.2. Format</h3>
<div class="ulist">
<ul>
<li>
<p>Title: Decision identifier</p>
</li>
<li>
<p>Status: Proposed, Accepted, Deprecated, Superseded</p>
</li>
<li>
<p>Context: The problem</p>
</li>
<li>
<p>Decision: The choice made</p>
</li>
<li>
<p>Consequences: Impact and trade-offs</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_records">C.3. Records</h3>
<div class="sect3">
<h4 id="_adr_001_container_first_architecture">C.3.1. ADR-001: Container-First Architecture</h4>
<div class="paragraph">
<p><strong>Status:</strong> Accepted</p>
</div>
<div class="paragraph">
<p><strong>Date:</strong> 2025-12-14</p>
</div>
<div class="sect4">
<h5 id="_context">C.3.1.1. Context</h5>
<div class="paragraph">
<p>Pi Zero microscope project requires portability across hardware variants (Zero, Zero 2, etc.).</p>
</div>
<div class="paragraph">
<p>System dependencies create deployment friction:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Python packages scattered on host</p>
</li>
<li>
<p>Manual I2C/SPI configuration</p>
</li>
<li>
<p>Version conflicts</p>
</li>
<li>
<p>Rebuild complexity</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Testing on bare metal pollutes host system.
Direct pip install with <code>--break-system-packages</code> breaks system integrity.</p>
</div>
</div>
<div class="sect4">
<h5 id="_decision">C.3.1.2. Decision</h5>
<div class="paragraph">
<p>All application code runs in Docker containers.</p>
</div>
<div class="paragraph">
<p>Host system configuration limited to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Docker installation</p>
</li>
<li>
<p>I2C enabled (<code>dtparam=i2c_arm=on</code>)</p>
</li>
<li>
<p>SPI enabled (<code>dtparam=spi=on</code>)</p>
</li>
<li>
<p>Device permissions (i2c, spi, video groups)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>No Python packages installed on host.
No application dependencies on host.</p>
</div>
<div class="paragraph">
<p>Container provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Complete runtime environment</p>
</li>
<li>
<p>All Python dependencies</p>
</li>
<li>
<p>Reproducible builds</p>
</li>
<li>
<p>Hardware device access via volume mounts</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Testing on bare Pi is interim only.
All Pi testing is throwaway.
Pi will be rebuilt from clean image.</p>
</div>
</div>
<div class="sect4">
<h5 id="_consequences">C.3.1.3. Consequences</h5>
<div class="sect5">
<h6 id="_positive">C.3.1.3.1. Positive</h6>
<div class="ulist">
<ul>
<li>
<p>Hardware portability guaranteed</p>
</li>
<li>
<p>Clean host system</p>
</li>
<li>
<p>Reproducible deployments</p>
</li>
<li>
<p>Version control of full stack</p>
</li>
<li>
<p>Easy migration to Zero 2 or other hardware</p>
</li>
<li>
<p>No manual dependency management</p>
</li>
<li>
<p>Container is deployment artifact</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_negative">C.3.1.3.2. Negative</h6>
<div class="ulist">
<ul>
<li>
<p>Docker required on Pi</p>
</li>
<li>
<p>Container build time overhead</p>
</li>
<li>
<p>Privileged mode required for hardware access</p>
</li>
<li>
<p>Docker is an abstraction</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_implementation">C.3.1.3.3. Implementation</h6>
<div class="ulist">
<ul>
<li>
<p>Dockerfile defines complete environment</p>
</li>
<li>
<p>docker-compose.yml maps devices and volumes</p>
</li>
<li>
<p>Deployment script handles container lifecycle</p>
</li>
<li>
<p>Host setup documented in single guide</p>
</li>
<li>
<p>No host package pollution</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adr_008_asciidoc_conditional_settings_for_multi_format_publishing">C.3.2. ADR-008: AsciiDoc Conditional Settings for Multi-Format Publishing</h4>
<div class="paragraph">
<p><strong>Status:</strong> Accepted</p>
</div>
<div class="paragraph">
<p><strong>Date:</strong> 2025-12-15</p>
</div>
<div class="sect4">
<h5 id="_context_2">C.3.2.1. Context</h5>
<div class="paragraph">
<p>Documentation uses AsciiDoc format for multiple output targets: GitHub rendering, PDF compilation, and central documentation site.</p>
</div>
<div class="paragraph">
<p>GitHub renders AsciiDoc directly but does not process include directives. This limits settings to inline declarations.</p>
</div>
<div class="paragraph">
<p>Compiled AsciiDoc processes includes, allowing settings in separate files for PDF generation.</p>
</div>
<div class="paragraph">
<p>Images require conditional imagesdir setting for book format to display correctly in compiled docs while maintaining GitHub compatibility.</p>
</div>
<div class="paragraph">
<p>Notes and other blocks need inline settings for GitHub visibility, but can use included settings for compiled formats.</p>
</div>
</div>
<div class="sect4">
<h5 id="_decision_2">C.3.2.2. Decision</h5>
<div class="paragraph">
<p>Use conditional blocks for imagesdir management:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set imagesdir to local images directory when flag-book is defined</p>
</li>
<li>
<p>Store original imagesdir before changing</p>
</li>
<li>
<p>Reset imagesdir after image blocks</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Keep settings for notes and blocks inline in main documents for GitHub compatibility.</p>
</div>
<div class="paragraph">
<p>Place PDF-specific settings in included files for compiled documentation.</p>
</div>
</div>
<div class="sect4">
<h5 id="_consequences_2">C.3.2.3. Consequences</h5>
<div class="sect5">
<h6 id="_positive_2">C.3.2.3.1. Positive</h6>
<div class="ulist">
<ul>
<li>
<p>Images display correctly in GitHub and compiled formats</p>
</li>
<li>
<p>Notes and blocks render properly on GitHub</p>
</li>
<li>
<p>PDF settings remain organized in separate files</p>
</li>
<li>
<p>Maintains clean separation between formats</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_negative_2">C.3.2.3.2. Negative</h6>
<div class="ulist">
<ul>
<li>
<p>Adds complexity to document structure</p>
</li>
<li>
<p>Requires careful management of conditional blocks</p>
</li>
<li>
<p>Inline settings reduce modularity for GitHub-focused docs</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adr_002_security_model_and_authentication">C.3.3. ADR-002: Security Model and Authentication</h4>
<div class="paragraph">
<p><strong>Status:</strong> Accepted</p>
</div>
<div class="paragraph">
<p><strong>Date:</strong> 2025-12-15</p>
</div>
<div class="sect4">
<h5 id="_context_3">C.3.3.1. Context</h5>
<div class="paragraph">
<p>System provides web interface for microscope camera control.
Might handle sensitive microscope images and captures.
Network exposure requires protection against unauthorized access.</p>
</div>
<div class="ulist">
<div class="title">Security requirements:</div>
<ul>
<li>
<p>Prevent unauthorized access to camera controls</p>
</li>
<li>
<p>Protect captured images from unauthorized viewing or deletion</p>
</li>
<li>
<p>Encrypt network traffic to prevent interception</p>
</li>
<li>
<p>Prevent file system attacks through path manipulation</p>
</li>
<li>
<p>Limit container privileges to reduce attack surface</p>
</li>
<li>
<p>Enable monitoring without compromising security</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_decision_3">C.3.3.2. Decision</h5>
<div class="paragraph">
<p>Implement layered security approach:</p>
</div>
<div class="sect5">
<h6 id="_authentication_3">C.3.3.2.1. Authentication</h6>
<div class="paragraph">
<p>Basic HTTP authentication on all endpoints except health check.
Credentials configured via environment variables (in MVP).
Health endpoint remains unauthenticated for monitoring systems.</p>
</div>
</div>
<div class="sect5">
<h6 id="_httpstls_2">C.3.3.2.2. HTTPS/TLS</h6>
<div class="ulist">
<ul>
<li>
<p>Self-signed certificate generated during container build.</p>
</li>
<li>
<p>HTTPS enabled by default.</p>
</li>
<li>
<p>HTTP fallback available via configuration.</p>
</li>
<li>
<p>Possible next step with let&#8217;s encrypt and forward proxy (as opposed to reverse).</p>
<div class="ulist">
<ul>
<li>
<p>Forward proxy allows encapsulated environment with own domain not exposed to internet.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_path_traversal_protection_2">C.3.3.2.3. Path Traversal Protection</h6>
<div class="paragraph">
<p>All file operations validate resolved paths.
Python <code>pathlib.resolve().is_relative_to()</code> prevents directory traversal.
Only files within <code>/app/captures</code> accessible.</p>
</div>
</div>
<div class="sect5">
<h6 id="_least_privilege">C.3.3.2.4. Least Privilege</h6>
<div class="ulist">
<ul>
<li>
<p>Remove privileged container mode (needs to be tested and might return).</p>
</li>
<li>
<p>Map specific devices only.</p>
</li>
<li>
<p>No unnecessary host access.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_consequences_3">C.3.3.3. Consequences</h5>
<div class="sect5">
<h6 id="_positive_3">C.3.3.3.1. Positive</h6>
<div class="ulist">
<ul>
<li>
<p>Unauthorized access prevented</p>
</li>
<li>
<p>Network traffic encrypted</p>
</li>
<li>
<p>File system attacks blocked</p>
</li>
<li>
<p>Reduced attack surface</p>
</li>
<li>
<p>Health monitoring still functional</p>
</li>
<li>
<p>Simple credential management</p>
<div class="ulist">
<ul>
<li>
<p>MVP for one user</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_negative_3">C.3.3.3.2. Negative</h6>
<div class="ulist">
<ul>
<li>
<p>Self-signed certificate triggers browser warnings</p>
</li>
<li>
<p>Basic auth not suitable for high-security environments</p>
</li>
<li>
<p>Credentials stored in compose file</p>
</li>
<li>
<p>No multi-user support</p>
</li>
<li>
<p>No audit logging</p>
</li>
<li>
<p>No rate limiting</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_mitigation">C.3.3.3.3. Mitigation</h6>
<div class="ulist">
<ul>
<li>
<p>Document security limitations.</p>
</li>
<li>
<p>Recommend reverse/forward proxy for production.</p>
</li>
<li>
<p>Provide credential generation guidance.</p>
</li>
<li>
<p>Plan proper authentication for production use.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_implementation_2">C.3.3.3.4. Implementation</h6>
<div class="ulist">
<div class="title">Environment variables:</div>
<ul>
<li>
<p><code>WEB_USERNAME</code> - Authentication username</p>
</li>
<li>
<p><code>WEB_PASSWORD</code> - Authentication password</p>
</li>
<li>
<p><code>ENABLE_HTTPS</code> - Enable HTTPS mode</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Certificate location: <code>/app/certs/</code></p>
</div>
<div class="paragraph">
<p>Protected endpoints: All except <code>/health</code></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_future_improvements">C.3.3.4. Future Improvements</h5>
<div class="ulist">
<ul>
<li>
<p>OAuth2/OIDC integration</p>
</li>
<li>
<p>Certificate management via Let&#8217;s Encrypt</p>
</li>
<li>
<p>Audit logging</p>
</li>
<li>
<p>Rate limiting</p>
</li>
<li>
<p>Session management</p>
</li>
<li>
<p>Multi-user support</p>
</li>
<li>
<p>Role-based access control</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adr_003_led_event_queue_pattern">C.3.4. ADR-003: LED Event Queue Pattern</h4>
<div class="paragraph">
<p><strong>Status:</strong> Proposed</p>
</div>
<div class="paragraph">
<p><strong>Date:</strong> 2025-12-15</p>
</div>
<div class="sect4">
<h5 id="_context_4">C.3.4.1. Context</h5>
<div class="paragraph">
<p>LED control needed from multiple sources:
* Web server on image capture
* Battery monitor for status
* Camera service for streaming indicator
* System health checks
* Admin interface for testing</p>
</div>
<div class="paragraph">
<p>Direct function calls create tight coupling.
LED operations block calling code.
Multiple sources compete for LED control.</p>
</div>
<div class="paragraph">
<p>Event queue pattern designed in architecture docs.
Worker thread processes events async.
Decouples producers from LED hardware.</p>
</div>
<div class="paragraph">
<p>Current code uses direct LED function calls.</p>
</div>
</div>
<div class="sect4">
<h5 id="_decision_4">C.3.4.2. Decision</h5>
<div class="paragraph">
<p>Event queue pattern is design goal.
Direct calls acceptable for current simple use case.</p>
</div>
<div class="paragraph">
<p>Implement event queue when:
* Battery monitoring integrated
* Multi-camera switching added
* LED admin interface created
* Animation conflicts occur</p>
</div>
</div>
<div class="sect4">
<h5 id="_consequences_4">C.3.4.3. Consequences</h5>
<div class="sect5">
<h6 id="_positive_direct_calls_current">C.3.4.3.1. Positive - Direct Calls (Current)</h6>
<div class="ulist">
<ul>
<li>
<p>Simple implementation</p>
</li>
<li>
<p>Fewer moving parts</p>
</li>
<li>
<p>Easy to debug</p>
</li>
<li>
<p>No queue overhead</p>
</li>
<li>
<p>Adequate for single camera</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_negative_direct_calls_current">C.3.4.3.2. Negative - Direct Calls (Current)</h6>
<div class="ulist">
<ul>
<li>
<p>Tight coupling between modules</p>
</li>
<li>
<p>LED calls may block</p>
</li>
<li>
<p>Cannot prioritize events</p>
</li>
<li>
<p>Hard to add new LED features</p>
</li>
<li>
<p>Testing requires hardware</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_positive_event_queue_future">C.3.4.3.3. Positive - Event Queue (Future)</h6>
<div class="ulist">
<ul>
<li>
<p>Async non-blocking operations</p>
</li>
<li>
<p>Multiple producers supported</p>
</li>
<li>
<p>Priority queue possible</p>
</li>
<li>
<p>Centralized LED logic</p>
</li>
<li>
<p>Easy testing via event injection</p>
</li>
<li>
<p>Animations don&#8217;t conflict</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_negative_event_queue_future">C.3.4.3.4. Negative - Event Queue (Future)</h6>
<div class="ulist">
<ul>
<li>
<p>More complex</p>
</li>
<li>
<p>Additional thread management</p>
</li>
<li>
<p>Queue full scenarios</p>
</li>
<li>
<p>Event ordering considerations</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_implementation_plan">C.3.4.4. Implementation Plan</h5>
<div class="ulist">
<div class="title">Phase 1 (current):</div>
<ul>
<li>
<p>Direct LED calls in web server</p>
</li>
<li>
<p>Simple flash on capture</p>
</li>
<li>
<p>System status indication</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Phase 2 (when battery added):</div>
<ul>
<li>
<p>Introduce event queue</p>
</li>
<li>
<p>Worker thread processes events</p>
</li>
<li>
<p>Battery publishes status events</p>
</li>
<li>
<p>Web server publishes capture events</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Phase 3 (multi-camera):</div>
<ul>
<li>
<p>Streaming events per camera</p>
</li>
<li>
<p>Source indicator on LEDs</p>
</li>
<li>
<p>Camera switching animations</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_technical_details">C.3.4.5. Technical Details</h5>
<div class="sect5">
<h6 id="_event_types">C.3.4.5.1. Event Types</h6>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="n">EventType</span><span class="p">.</span><span class="n">SYSTEM_STATUS</span>  <span class="o">-&gt;</span> <span class="n">Row</span> <span class="mi">0</span><span class="p">:</span> <span class="n">System</span> <span class="nf">health </span><span class="p">(</span><span class="n">green</span><span class="p">)</span>
<span class="n">EventType</span><span class="p">.</span><span class="n">STREAMING</span>      <span class="o">-&gt;</span> <span class="n">Row</span> <span class="mi">1</span><span class="p">:</span> <span class="n">Streaming</span> <span class="nf">active </span><span class="p">(</span><span class="n">red</span><span class="p">)</span>
<span class="n">EventType</span><span class="p">.</span><span class="n">CAPTURE</span>        <span class="o">-&gt;</span> <span class="n">Row</span> <span class="mi">2</span><span class="p">:</span> <span class="n">Capture</span> <span class="nf">flash </span><span class="p">(</span><span class="n">white</span><span class="p">)</span>
<span class="n">EventType</span><span class="p">.</span><span class="n">BATTERY</span>        <span class="o">-&gt;</span> <span class="n">Row</span> <span class="mi">3</span><span class="p">:</span> <span class="n">Battery</span> <span class="nf">gauge </span><span class="p">(</span><span class="mi">8</span> <span class="n">LEDs</span><span class="p">)</span>
<span class="n">EventType</span><span class="p">.</span><span class="n">ANIMATION</span>      <span class="o">-&gt;</span> <span class="n">Startup</span><span class="o">/</span><span class="n">shutdown</span><span class="o">/</span><span class="n">rainbow</span><span class="o">/</span><span class="n">pulse</span>
<span class="n">EventType</span><span class="p">.</span><span class="n">TEST</span>           <span class="o">-&gt;</span> <span class="n">Test</span> <span class="n">patterns</span> <span class="k">for</span> <span class="n">admin</span> <span class="n">page</span>
<span class="n">EventType</span><span class="p">.</span><span class="n">SHUTDOWN</span>       <span class="o">-&gt;</span> <span class="n">Low</span> <span class="n">battery</span> <span class="nf">warning </span><span class="p">(</span><span class="n">blink</span> <span class="n">red</span><span class="p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_led_row_assignment">C.3.4.5.2. LED Row Assignment</h6>
<div class="ulist">
<ul>
<li>
<p>Row 3 (Top): Battery Level (8-LED gauge)</p>
<div class="ulist">
<ul>
<li>
<p>Green=full, Yellow=med, Orange=low, Red=critical</p>
</li>
<li>
<p>Cyan=charging</p>
</li>
</ul>
</div>
</li>
<li>
<p>Row 2: Capture Flash (white, 2s)</p>
</li>
<li>
<p>Row 1: Streaming Status (red when active)</p>
<div class="ulist">
<ul>
<li>
<p>Source indicator possible</p>
</li>
</ul>
</div>
</li>
<li>
<p>Row 0 (Bottom): System Status (green when OK)</p>
<div class="ulist">
<ul>
<li>
<p>Left half=camera, Right half=system</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_benefits">C.3.4.5.3. Benefits</h6>
<div class="ulist">
<ul>
<li>
<p>Async/non-blocking - no delays in main app</p>
</li>
<li>
<p>Multiple sources can send events</p>
</li>
<li>
<p>Centralized LED control logic</p>
</li>
<li>
<p>Easy to add battery, temp, etc.</p>
</li>
<li>
<p>Test mode can inject events</p>
</li>
<li>
<p>Python stdlib only (no MQTT overhead)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_led_test_interface">C.3.4.6. LED Test Interface</h5>
<div class="ulist">
<div class="title">Admin page at <code>/admin/leds</code> with:</div>
<ul>
<li>
<p>Event injection controls</p>
</li>
<li>
<p>Animation triggers</p>
</li>
<li>
<p>Current state display</p>
</li>
<li>
<p>Test patterns</p>
</li>
<li>
<p>Battery simulation</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_references_2">C.3.4.7. References</h5>
<div class="paragraph">
<p>Pattern documented but deferred until needed.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adr_004_battery_monitoring_architecture">C.3.5. ADR-004: Battery Monitoring Architecture</h4>
<div class="paragraph">
<p><strong>Status:</strong> Proposed</p>
</div>
<div class="paragraph">
<p><strong>Date:</strong> 2025-12-15</p>
</div>
<div class="sect4">
<h5 id="_context_5">C.3.5.1. Context</h5>
<div class="paragraph">
<p>Pi Zero runs on UPS PIco battery HAT.
System must protect against data loss on power failure.</p>
</div>
<div class="ulist">
<div class="title">Battery status needed for:</div>
<ul>
<li>
<p>Graceful shutdown below threshold</p>
</li>
<li>
<p>LED battery gauge display</p>
</li>
<li>
<p>System health monitoring</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_decision_5">C.3.5.2. Decision</h5>
<div class="paragraph">
<p>Integrate battery monitoring when LED event queue implemented.
Monitor UPS PIco via I2C at address 0x69.
Implement three-tier threshold system.</p>
</div>
<div class="sect5">
<h6 id="_thresholds">C.3.5.2.1. Thresholds</h6>
<div class="paragraph">
<p>Low warning: 20%
* Yellow/orange LEDs
* Log warning</p>
</div>
<div class="paragraph">
<p>Critical: 10%
* Red blinking LEDs
* Initiate shutdown countdown</p>
</div>
<div class="paragraph">
<p>Emergency: &lt;5%
* Immediate shutdown
* Flush buffers
* Safe camera stop</p>
</div>
</div>
<div class="sect5">
<h6 id="_shutdown_sequence">C.3.5.2.2. Shutdown Sequence</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Detect battery below critical threshold</p>
</li>
<li>
<p>Send shutdown event to LED (red blink 5x)</p>
</li>
<li>
<p>Wait 3 seconds for visual warning</p>
</li>
<li>
<p>Stop camera gracefully</p>
</li>
<li>
<p>Flush capture buffer</p>
</li>
<li>
<p>Execute system shutdown</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_consequences_5">C.3.5.3. Consequences</h5>
<div class="sect5">
<h6 id="_positive_4">C.3.5.3.1. Positive</h6>
<div class="ulist">
<ul>
<li>
<p>Data loss prevented</p>
</li>
<li>
<p>Clear battery warnings</p>
</li>
<li>
<p>Graceful shutdown</p>
</li>
<li>
<p>User sees battery status</p>
</li>
<li>
<p>System protected</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_negative_4">C.3.5.3.2. Negative</h6>
<div class="ulist">
<ul>
<li>
<p>Additional monitoring thread</p>
</li>
<li>
<p>Shutdown may interrupt captures</p>
</li>
<li>
<p>Battery HAT required for full function</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_implementation_3">C.3.5.3.3. Implementation</h6>
<div class="paragraph">
<p>Environment variables:
* <code>ENABLE_BATTERY_MONITOR</code> - Enable/disable
* <code>BATTERY_LOW_THRESHOLD</code> - Default 20
* <code>BATTERY_CRITICAL_THRESHOLD</code> - Default 10</p>
</div>
<div class="paragraph">
<p>Battery monitor runs in separate thread.
Polls every 5 seconds.
Publishes events to LED queue.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_integration_points">C.3.5.4. Integration Points</h5>
<div class="ulist">
<div class="title">Battery service:</div>
<ul>
<li>
<p><code>battery_status.py</code> - Already exists</p>
</li>
<li>
<p>I2C communication with UPS-lite v1.3</p>
</li>
<li>
<p>Voltage and capacity reading</p>
</li>
<li>
<p>Charging status detection</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">LED display:</div>
<ul>
<li>
<p>Row 3 (top) - 8-LED battery gauge</p>
</li>
<li>
<p>Green when full</p>
</li>
<li>
<p>Yellow when low</p>
</li>
<li>
<p>Red when critical</p>
</li>
<li>
<p>Cyan when charging</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Web interface:</div>
<ul>
<li>
<p>Battery status in system info</p>
</li>
<li>
<p>Charge percentage displayed</p>
</li>
<li>
<p>Charging indicator</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Health endpoint:</div>
<ul>
<li>
<p>Include battery status</p>
</li>
<li>
<p>Warning if below threshold</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_safety_considerations">C.3.5.5. Safety Considerations</h5>
<div class="paragraph">
<p>Shutdown initiated by container.
Requires host shutdown capability.
May need privileged mode or specific capability.</p>
</div>
<div class="paragraph">
<p>Alternative: Notify external monitor.
External system handles shutdown.
Container only reports status.</p>
</div>
</div>
<div class="sect4">
<h5 id="_current_status">C.3.5.6. Current Status</h5>
<div class="paragraph">
<p>Module exists: <code>docker/docker-microscope/battery_status.py</code></p>
</div>
<div class="paragraph">
<p>Not imported in web server.
Not integrated with LED system.
Environment variables configured in compose.</p>
</div>
<div class="paragraph">
<p>Waiting for LED event queue implementation.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adr_005_multi_camera_source_management">C.3.6. ADR-005: Multi-Camera Source Management</h4>
<div class="paragraph">
<p><strong>Status:</strong> Proposed</p>
</div>
<div class="paragraph">
<p><strong>Date:</strong> 2025-12-15</p>
</div>
<div class="sect4">
<h5 id="_context_6">C.3.6.1. Context</h5>
<div class="ulist">
<div class="title">System designed for three (or more) camera sources:</div>
<ul>
<li>
<p>HDMI capture via MacroSilicon USB adapter</p>
<div class="ulist">
<ul>
<li>
<p>For now&#8230;&#8203; next step is to use that for an additional camera</p>
</li>
</ul>
</div>
</li>
<li>
<p>Direct USB microscope camera</p>
<div class="ulist">
<ul>
<li>
<p>currently the usb capture device as no HUB used</p>
</li>
</ul>
</div>
</li>
<li>
<p>Raspberry Pi Camera Module (CSI) (with night vision)</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Current</div>
<ul>
<li>
<p>Current implementation supports single camera only.</p>
</li>
<li>
<p>Camera device hardcoded in configuration.</p>
</li>
<li>
<p>No source detection or switching.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Goal</div>
<ul>
<li>
<p>Architecture documents stream deck interface.</p>
</li>
<li>
<p>User can switch between sources.</p>
</li>
<li>
<p>Each source requires different configuration.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Potentail further cameras:</div>
<ul>
<li>
<p>Additional USB microscopes via powered hub</p>
<div class="ulist">
<ul>
<li>
<p>eg thermal camera</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_decision_6">C.3.6.2. Decision</h5>
<div class="paragraph">
<p>Defer multi-camera until single camera stable.</p>
</div>
<div class="ulist">
<div class="title">When implemented:</div>
<ul>
<li>
<p>Auto-detect available cameras on startup</p>
<div class="ulist">
<ul>
<li>
<p>should do now even for single camera</p>
</li>
</ul>
</div>
</li>
<li>
<p>Maintain separate camera service per source</p>
</li>
<li>
<p>Switch active stream via API endpoint</p>
</li>
<li>
<p>Show source thumbnails in UI</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="_detection_strategy">C.3.6.2.1. Detection Strategy</h6>
<div class="ulist">
<div class="title">Scan video devices on startup:</div>
<ul>
<li>
<p><code>/dev/video0</code> through <code>/dev/video4</code></p>
</li>
<li>
<p>Query capabilities with v4l2</p>
</li>
<li>
<p>Identify device by USB ID or driver</p>
</li>
<li>
<p>Store available sources</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_switching_approaches">C.3.6.2.2. Switching Approaches</h6>
<div class="ulist">
<div class="title">Option 1: V4L2 switching (simpler)</div>
<ul>
<li>
<p>Single Flask stream endpoint</p>
</li>
<li>
<p>Switch camera service backend</p>
</li>
<li>
<p>One stream at a time</p>
</li>
<li>
<p>Lower bandwidth</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Option 2: Multiple streams (complex)</div>
<ul>
<li>
<p>Separate endpoint per camera</p>
</li>
<li>
<p>Client-side switching</p>
</li>
<li>
<p>Simultaneous preview possible</p>
</li>
<li>
<p>Higher bandwidth</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Decision:</div>
<ul>
<li>
<p>Start with Option 1.</p>
</li>
<li>
<p>Upgrade to Option 2 if preview needed.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_consequences_6">C.3.6.3. Consequences</h5>
<div class="sect5">
<h6 id="_positive_deferred">C.3.6.3.1. Positive - Deferred</h6>
<div class="ulist">
<ul>
<li>
<p>Simpler current implementation</p>
</li>
<li>
<p>Single camera well-tested</p>
</li>
<li>
<p>Easier deployment</p>
</li>
<li>
<p>Lower resource usage</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_negative_deferred">C.3.6.3.2. Negative - Deferred</h6>
<div class="ulist">
<ul>
<li>
<p>Cannot use multiple microscopes</p>
</li>
<li>
<p>Manual config to switch sources</p>
</li>
<li>
<p>No camera comparison</p>
</li>
<li>
<p>Limited use cases</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_positive_when_implemented">C.3.6.3.3. Positive - When Implemented</h6>
<div class="ulist">
<ul>
<li>
<p>Flexible microscope setup</p>
</li>
<li>
<p>Easy source comparison</p>
</li>
<li>
<p>Support different microscopes</p>
</li>
<li>
<p>Stream deck interface</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_negative_when_implemented">C.3.6.3.4. Negative - When Implemented</h6>
<div class="ulist">
<ul>
<li>
<p>More complex device management</p>
</li>
<li>
<p>Camera initialization overhead</p>
</li>
<li>
<p>Source switching latency</p>
</li>
<li>
<p>Higher resource usage</p>
<div class="ulist">
<ul>
<li>
<p>Could well be beyond pi zero</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_implementation_plan_2">C.3.6.4. Implementation Plan</h5>
<div class="ulist">
<div class="title">Phase 1 (current):</div>
<ul>
<li>
<p>Single camera via VIDEO_DEVICE env var</p>
</li>
<li>
<p>Manual configuration</p>
</li>
<li>
<p>Restart to switch</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Phase 2 (detection):</div>
<ul>
<li>
<p>Scan available cameras</p>
</li>
<li>
<p>Report in /status endpoint</p>
</li>
<li>
<p>UI shows available sources</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Phase 3 (switching):</div>
<ul>
<li>
<p><code>/switch/&lt;source&gt;</code> endpoint</p>
</li>
<li>
<p>Stop current camera</p>
</li>
<li>
<p>Start new camera</p>
</li>
<li>
<p>Update LED streaming indicator</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Phase 4 (stream deck):</div>
<ul>
<li>
<p>Thumbnail previews</p>
</li>
<li>
<p>Click to switch</p>
</li>
<li>
<p>Source status indicators</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>slowly slowly catchy monkey.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_stream_deck_interface">C.3.6.5. Stream Deck Interface</h5>
<div class="sect5">
<h6 id="_features">C.3.6.5.1. Features</h6>
<div class="ulist">
<ul>
<li>
<p>Preview tiles for each source (thumbnail grid)</p>
</li>
<li>
<p>Click to switch active source</p>
</li>
<li>
<p>Capture from any source</p>
</li>
<li>
<p>Download captured images</p>
</li>
<li>
<p>Source status indicators</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_ui_layout">C.3.6.5.2. UI Layout</h6>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>
 VSaGCR - Microscopy Interface        

            
 HDMI    USB    Pi    Sources 
              Cam            
            

 [Main Preview - Active Source]      
                                     

 [Capture] [Record] [Switch]         
 Battery:  85%               
</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_2">C.3.6.6. Configuration</h5>
<div class="paragraph">
<p>Environment variables per source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="s">VIDEO_DEVICE_HDMI=/dev/video0</span>
<span class="s">VIDEO_DEVICE_USB=/dev/video1</span>
<span class="s">VIDEO_DEVICE_CSI=/dev/video2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Auto-detection overrides if devices found.
Maybe even just forgo config entirely if dynamic is good enough.</p>
</div>
</div>
<div class="sect4">
<h5 id="_led_integration">C.3.6.7. LED Integration</h5>
<div class="paragraph">
<p>Row 1 streaming indicator shows active source:
* Left side: HDMI
* Center: USB
* Right: CSI</p>
</div>
<div class="paragraph">
<p>Animations on source switch.</p>
</div>
</div>
<div class="sect4">
<h5 id="_current_status_2">C.3.6.8. Current Status</h5>
<div class="paragraph">
<p>Single camera only.
Configured via VIDEO_DEVICE.
Multi-camera documented in architecture.</p>
</div>
<div class="paragraph">
<p>Waiting for:
* Production deployment experience
* User feedback on single camera (me)
* LED event queue implementation</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adr_006_directory_structure">C.3.7. ADR-006: Directory Structure</h4>
<div class="paragraph">
<p><strong>Status:</strong> Accepted</p>
</div>
<div class="paragraph">
<p><strong>Date:</strong> 2025-12-15</p>
</div>
<div class="sect4">
<h5 id="_context_7">C.3.7.1. Context</h5>
<div class="ulist">
<ul>
<li>
<p>Need a clear directory structure for project.</p>
</li>
<li>
<p>Want to have this as a well documented project.</p>
</li>
<li>
<p>People should find files easily (others and me).</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_decision_7">C.3.7.2. Decision</h5>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>/docker/
  /docker-microscope/     # Container application
  docker-compose.yml      # Service definition
  README.adoc            # Docker deployment docs

/adr/                    # Architecture decisions

/prep-scripts/          # Hardware prep and test scripts

/images/                 # Diagrams and screenshots

Root level files:
  README.asciidoc        # Main project docs (consolidated)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_consequences_7">C.3.7.3. Consequences</h5>
<div class="sect5">
<h6 id="_positive_5">C.3.7.3.1. Positive</h6>
<div class="ulist">
<ul>
<li>
<p>Clear separation of concerns</p>
</li>
<li>
<p>Docker files grouped logically</p>
</li>
<li>
<p>Build context simplified</p>
</li>
<li>
<p>Easier to find components</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_rationale">C.3.7.4. Rationale</h5>
<div class="paragraph">
<p><code>/docker</code> groups all container-related files.
Sub-directory per container project.
Multiple containers possible in future.</p>
</div>
<div class="paragraph">
<p>Example expansion:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>/docker/
  /docker-microscope/
  /docker-analysis/       # Future: image processing
  /docker-storage/        # Future: backup service
  docker-compose.yml      # Orchestrates all</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adr_007_privileged_container_mode_removal">C.3.8. ADR-007: Privileged Container Mode Removal</h4>
<div class="paragraph">
<p><strong>Status:</strong> Accepted</p>
</div>
<div class="paragraph">
<p><strong>Date:</strong> 2025-12-15</p>
</div>
<div class="sect4">
<h5 id="_context_8">C.3.8.1. Context</h5>
<div class="paragraph">
<p>Initial container configuration used <code>privileged: true</code>.</p>
</div>
<div class="ulist">
<div class="title">Original justification:</div>
<ul>
<li>
<p>Hardware access for GPIO</p>
</li>
<li>
<p>SPI interface for LEDs</p>
</li>
<li>
<p>I2C for battery monitor</p>
</li>
<li>
<p>Video device access</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Privileged mode grants full host access.</p>
</div>
<div class="ulist">
<div class="title">Container can:</div>
<ul>
<li>
<p>Access all devices</p>
</li>
<li>
<p>Modify kernel settings</p>
</li>
<li>
<p>Escape container isolation</p>
</li>
<li>
<p>Bypass security controls</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Problem?</div>
<ul>
<li>
<p>Violates least-privilege principle.</p>
<div class="ulist">
<ul>
<li>
<p>But does it matter here as the things is dedicated anyhow</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_decision_8">C.3.8.2. Decision</h5>
<div class="paragraph">
<p>Remove privileged mode completely.
Use specific device mappings only.</p>
</div>
<div class="ulist">
<div class="title">Devices explicitly mapped:</div>
<ul>
<li>
<p><code>/dev/video1</code> - Camera capture</p>
</li>
<li>
<p><code>/dev/gpiomem</code> - GPIO memory (LEDs)</p>
</li>
<li>
<p><code>/dev/spidev0.0</code> - SPI interface (Unicorn HAT)</p>
</li>
<li>
<p><code>/dev/i2c-1</code> - I2C bus (battery monitor)</p>
</li>
<li>
<p><code>/dev/vchiq</code> - VideoCore interface</p>
</li>
<li>
<p><code>/dev/vcsm-cma</code> - VideoCore shared memory</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Read-only volumes:</div>
<ul>
<li>
<p><code>/sys:ro</code> - System information</p>
</li>
<li>
<p><code>/run/udev:ro</code> - Device events</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_consequences_8">C.3.8.3. Consequences</h5>
<div class="sect5">
<h6 id="_positive_6">C.3.8.3.1. Positive</h6>
<div class="ulist">
<ul>
<li>
<p>Reduced attack surface</p>
</li>
<li>
<p>Container isolation maintained</p>
</li>
<li>
<p>Host protection enhanced</p>
<div class="ulist">
<ul>
<li>
<p>not as important right now but maybe in future</p>
</li>
</ul>
</div>
</li>
<li>
<p>Follows security best practices</p>
</li>
<li>
<p>Complies with security standards</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_negative_5">C.3.8.3.2. Negative</h6>
<div class="ulist">
<ul>
<li>
<p>More verbose device configuration</p>
</li>
<li>
<p>Must update for new hardware</p>
</li>
<li>
<p>Device permissions still required on host</p>
</li>
<li>
<p>Some features may need capabilities</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_host_configuration_required">C.3.8.4. Host Configuration Required</h5>
<div class="paragraph">
<p>Devices must exist with proper permissions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># Enable I2C and SPI</span>
<span class="nb">sudo </span>raspi-config
<span class="c"># Interface Options  I2C  Enable</span>
<span class="c"># Interface Options  SPI  Enable</span>

<span class="c"># User in required groups</span>
<span class="nb">sudo </span>usermod <span class="nt">-aG</span> video,spi,i2c,gpio <span class="nv">$USER</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Device permissions checked on startup.
Container should fail fast if devices inaccessible.</p>
</div>
</div>
<div class="sect4">
<h5 id="_capabilities_considered">C.3.8.5. Capabilities Considered</h5>
<div class="paragraph">
<p>Alternative to privileged mode: Linux capabilities.</p>
</div>
<div class="ulist">
<div class="title">Potential:</div>
<ul>
<li>
<p><code>CAP_SYS_ADMIN</code> - Not required</p>
</li>
<li>
<p><code>CAP_SYS_RAWIO</code> - Not required</p>
</li>
<li>
<p><code>CAP_NET_ADMIN</code> - Not required</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Device access sufficient.</p>
</div>
<div class="paragraph">
<p>If future features need capabilities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">cap_add</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">SPECIFIC_CAPABILITY</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Document in ADR with justification.</p>
</div>
</div>
<div class="sect4">
<h5 id="_shutdown_capability">C.3.8.6. Shutdown Capability</h5>
<div class="paragraph">
<p>Battery monitoring may need system shutdown.
Options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>External shutdown monitor (chosen)</p>
<div class="ulist">
<ul>
<li>
<p>Container reports battery status</p>
</li>
<li>
<p>External service handles shutdown</p>
</li>
<li>
<p>No container privileges needed</p>
</li>
</ul>
</div>
</li>
<li>
<p>Shutdown capability</p>
<div class="ulist">
<ul>
<li>
<p>Add <code>CAP_SYS_BOOT</code></p>
</li>
<li>
<p>Container can shutdown host</p>
</li>
<li>
<p>Security consideration</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Current: Battery monitoring deferred.</p>
</div>
</div>
<div class="sect4">
<h5 id="_testing_results">C.3.8.7. Testing Results</h5>
<div class="paragraph">
<p>Container tested without privileged mode:
* Camera access: Works
* LED control: Works
* SPI communication: Works
* I2C access: Works (when enabled - Duh)
* Video capture: Works</p>
</div>
<div class="paragraph">
<p>All functionality maintained.
No privileged mode required.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-12-15 22:16:35 UTC
</div>
</div>
</body>
</html>