services:
  microscope:
    build: ./docker-microscope
    container_name: microscope-camera
    devices:
      - /dev/video1:/dev/video1
      - /dev/vchiq:/dev/vchiq
      - /dev/vcsm-cma:/dev/vcsm-cma
      - /dev/gpiomem:/dev/gpiomem
      - /dev/spidev0.0:/dev/spidev0.0
      - /dev/i2c-1:/dev/i2c-1
    ports:
      - "8443:8443"
      - "8080:8080"
    volumes:
      - microscope-captures:/app/captures
      - /run/udev:/run/udev:ro
      - /sys:/sys:ro
    environment:
      # Camera configuration
      - VIDEO_DEVICE=${VIDEO_DEVICE:-/dev/video1}
      - VIDEO_WIDTH=${VIDEO_WIDTH:-1280}
      - VIDEO_HEIGHT=${VIDEO_HEIGHT:-720}
      - VIDEO_FPS=${VIDEO_FPS:-30}
      
      # Web server configuration
      - WEB_PORT=${WEB_PORT:-8080}
      - ENABLE_HTTPS=${ENABLE_HTTPS:-true}
      - WEB_USERNAME=${WEB_USERNAME:-admin}
      - WEB_PASSWORD=${WEB_PASSWORD:-changeme_generate_secure_password}
      
      # Hardware features
      - ENABLE_LEDS=${ENABLE_LEDS:-true}
      - ENABLE_BATTERY_MONITOR=${ENABLE_BATTERY_MONITOR:-true}
      
      # Battery thresholds
      - BATTERY_LOW_THRESHOLD=${BATTERY_LOW_THRESHOLD:-20}
      - BATTERY_CRITICAL_THRESHOLD=${BATTERY_CRITICAL_THRESHOLD:-10}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import requests; requests.get('http://localhost:8080/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  microscope-captures:
    name: microscope-captures
